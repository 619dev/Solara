<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>音乐播放器</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        :root {
            --font-main: 'Noto Sans SC', 'Segoe UI', Arial, sans-serif;
            --bg-gradient: linear-gradient(140deg, #e0f5e9 0%, #c6f0e0 35%, #a3e4d7 100%);
            --container-bg: rgba(255, 255, 255, 0.6);
            --container-shadow: rgba(0, 0, 0, 0.1);
            --backdrop-blur: 12px;
            --text-color: #2c3e50;
            --text-secondary-color: #7f8c8d;
            --primary-color: #1abc9c;
            --primary-color-dark: #12836d;
            --warning-color: #e74c3c;
            --success-color: #2ecc71;
            --item-hover-bg: rgba(26, 188, 156, 0.1);
            --item-current-bg: rgba(26, 188, 156, 0.2);
            --item-current-text: var(--primary-color);
            --border-color: rgba(0, 0, 0, 0.1);
            --lyrics-highlight-bg: rgba(46, 204, 113, 0.12);
            --lyrics-highlight-text: #1e9f78;
            --lyrics-highlight-shadow: rgba(46, 204, 113, 0.18);
            --component-bg: rgba(255, 255, 255, 0.5);
            --scrollbar-thumb-bg: rgba(0, 0, 0, 0.2);
            --scrollbar-track-bg: transparent;
        }

        .dark-mode {
            --bg-gradient: linear-gradient(135deg, #0b1d1b 0%, #0f2f2c 45%, #123c36 100%);
            --container-bg: rgba(30, 30, 30, 0.6);
            --container-shadow: rgba(0, 0, 0, 0.3);
            --text-color: #ecf0f1;
            --text-secondary-color: #95a5a6;
            --primary-color: #1abc9c;
            --primary-color-dark: #17a589;
            --item-hover-bg: rgba(26, 188, 156, 0.1);
            --item-current-bg: rgba(26, 188, 156, 0.2);
            --border-color: rgba(255, 255, 255, 0.15);
            --lyrics-highlight-bg: rgba(26, 188, 156, 0.12);
            --lyrics-highlight-text: #34d1b6;
            --component-bg: rgba(44, 44, 44, 0.5);
            --scrollbar-thumb-bg: rgba(255, 255, 255, 0.2);
        }

        .dark-mode .quality-menu {
            background: rgba(44, 44, 44, 0.95);
            border: 2px solid var(--primary-color);
        }

        .dark-mode .quality-option {
            background: rgba(44, 44, 44, 0.8);
            color: #ecf0f1;
            border-bottom: 1px solid rgba(26, 188, 156, 0.25);
        }

        .dark-mode .player-quality-menu {
            background: rgba(44, 44, 44, 0.95);
            border-color: var(--primary-color);
        }

        .dark-mode .player-quality-option {
            color: #ecf0f1;
        }

        .dark-mode .player-quality-option:hover,
        .dark-mode .player-quality-option.active {
            color: #ffffff;
        }

        .dark-mode .source-menu {
            background: rgba(44, 44, 44, 0.95);
            border-color: var(--primary-color);
        }

        .dark-mode .source-option {
            color: #ecf0f1;
        }

        .dark-mode .source-option:hover,
        .dark-mode .source-option.active {
            color: #ffffff;
        }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--scrollbar-track-bg); }
        ::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb-bg); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary-color); }

        body {
            font-family: var(--font-main);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            background-image: var(--bg-gradient);
            background-attachment: fixed;
            color: var(--text-color);
            transition: background 0.5s, color 0.5s;
        }

        /* 16:9 容器布局 */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--container-bg);
            border-radius: 24px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            border: 1px solid var(--border-color);
            aspect-ratio: 16/9;
            height: 80vh;
            max-height: 700px;
            display: grid;
            grid-template-areas:
                "header header header"
                "search search search"
                "cover playlist lyrics"
                "controls controls controls";
            grid-template-rows: auto auto 1fr 80px;
            grid-template-columns: 300px 1fr 1fr;
            gap: 20px;
            transition: background 0.5s, box-shadow 0.5s;
            overflow: visible;
            position: relative;
        }

        /* 搜索模式下的容器布局 */
        .container.search-mode {
            grid-template-areas: 
                "header header header"
                "search search search"
                "search search search"
                "controls controls controls";
        }

        .header { 
            grid-area: header;
            text-align: center; 
            position: relative; 
        }
        .header h1 { 
            margin: 0; 
            font-size: 2.2em; 
            font-weight: 700; 
            color: var(--primary-color); 
            letter-spacing: 1px; 
        }
        .header .warning { 
            color: var(--text-secondary-color); 
            font-size: 0.9em; 
            margin-top: 10px; 
            font-style: italic; 
        }
        
        /* 搜索区域样式 - 增强动效 */
        .search-area {
            grid-area: search;
            background: var(--component-bg);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid var(--border-color);
            position: relative;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 10;
            overflow: visible;
            display: flex;
            flex-direction: column;
        }

        /* 搜索模式下的搜索区域 */
        .container.search-mode .search-area {
            background: var(--component-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            border: 2px solid var(--primary-color);
        }

        .search-container {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
            flex-shrink: 0;
        }

        .search-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            background: var(--component-bg);
            color: var(--text-color);
            font-size: 16px;
            font-family: inherit;
            outline: none;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(26, 188, 156, 0.12);
        }

        .source-select-wrapper {
            position: relative;
            flex-shrink: 0;
        }

        .source-select-btn {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            padding: 12px 18px;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            background: var(--component-bg);
            color: var(--text-color);
            font-size: 16px;
            font-family: inherit;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.25s ease;
            min-width: 150px;
            position: relative;
            box-shadow: none;
        }

        .source-select-btn:hover,
        .source-select-btn.active {
            border-color: var(--primary-color);
            color: var(--primary-color);
            box-shadow: 0 10px 24px rgba(26, 188, 156, 0.2);
            background: var(--component-bg);
        }

        .source-select-btn:focus-visible {
            outline: none;
            box-shadow: 0 0 0 3px rgba(26, 188, 156, 0.18);
        }

        .source-select-btn .caret-icon {
            font-size: 0.8em;
            transition: transform 0.25s ease;
        }

        .source-select-btn.active .caret-icon {
            transform: rotate(-180deg);
        }

        .source-menu {
            position: absolute;
            top: calc(100% + 10px);
            left: 0;
            right: auto;
            bottom: auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            box-shadow: 0 12px 30px rgba(0,0,0,0.18);
            border: 1px solid var(--border-color);
            box-sizing: border-box;
            min-width: 100%;
            max-height: 320px;
            overflow-y: auto;
            overflow-x: hidden;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: opacity 0.18s ease, transform 0.18s ease;
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            z-index: 100000;
            pointer-events: none;
        }

        .source-menu.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
            pointer-events: auto;
        }

        .source-menu.open-upwards {
            top: auto;
            bottom: calc(100% + 10px);
            transform-origin: bottom center;
        }

        .source-menu.open-downwards {
            top: calc(100% + 10px);
            bottom: auto;
            transform-origin: top center;
        }

        .source-option {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            padding: 12px 16px;
            font-size: 0.95em;
            color: var(--text-color);
            cursor: pointer;
            transition: all 0.2s ease;
            background: transparent;
        }

        .source-option:hover,
        .source-option.active {
            background: var(--primary-color);
            color: #ffffff;
        }

        .source-option i {
            font-size: 0.85em;
            opacity: 0.6;
        }

        .source-option.active i {
            opacity: 1;
        }

        .search-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 12px 20px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .search-btn:hover {
            background: var(--primary-color-dark);
            transform: translateY(-1px);
        }

        .search-btn:disabled {
            background: var(--text-secondary-color);
            cursor: not-allowed;
            transform: none;
        }

        /* 搜索结果区域 - 增强动效 */
        .search-results {
            max-height: 0;
            overflow: hidden;
            border-top: 1px solid var(--border-color);
            margin-top: 15px;
            margin-left: -20px;
            margin-right: -20px;
            margin-bottom: -20px;
            padding-top: 0;
            padding-left: 20px;
            padding-right: 20px;
            position: relative;
            z-index: 1;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 0;
            border-radius: 0 0 14px 14px;
            flex: 1;
            min-height: 0;
        }

        /* 搜索模式下的搜索结果 */
        .container.search-mode .search-results {
            max-height: none;
            height: 100%;
            padding-top: 15px;
            padding-bottom: 20px;
            opacity: 1;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .search-result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transform: translateY(20px);
            opacity: 0;
            animation: slideInUp 0.4s ease forwards;
        }

        .search-result-item.album {
            display: grid;
            grid-template-columns: 70px 1fr auto;
            gap: 18px;
            align-items: center;
            position: relative;
            overflow: hidden;
        }

        .search-result-item.album::after {
            content: "";
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(26, 188, 156, 0.12), transparent 55%);
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .search-result-item.album:hover::after {
            opacity: 1;
        }

        .album-thumb {
            width: 70px;
            height: 70px;
            border-radius: 16px;
            background: rgba(255, 255, 255, 0.45);
            border: 1px solid rgba(26, 188, 156, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            box-shadow: inset 0 0 0 1px rgba(255,255,255,0.3);
            position: relative;
        }

        .album-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .album-thumb i {
            font-size: 28px;
            color: var(--primary-color);
        }

        .search-result-item.album .search-result-info {
            align-self: stretch;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .search-result-item.album .search-result-title {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .search-result-item.album .search-result-title i {
            color: var(--primary-color);
        }

        .search-result-meta {
            margin-top: 4px;
            font-size: 12px;
            color: var(--text-secondary-color);
        }

        .album-result-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .album-result-actions .action-btn {
            min-width: 140px;
        }

        .album-result-actions .action-btn.secondary {
            background: rgba(255, 255, 255, 0.45);
            color: var(--primary-color);
            border: 1px solid rgba(26, 188, 156, 0.25);
        }

        .album-result-actions .action-btn.secondary:hover {
            background: var(--primary-color);
            color: #fff;
        }

        .dark-mode .album-result-actions .action-btn.secondary {
            background: rgba(30, 30, 30, 0.65);
            color: #ecf0f1;
            border-color: rgba(26, 188, 156, 0.35);
        }

        .search-result-item:nth-child(1) { animation-delay: 0.1s; }
        .search-result-item:nth-child(2) { animation-delay: 0.15s; }
        .search-result-item:nth-child(3) { animation-delay: 0.2s; }
        .search-result-item:nth-child(4) { animation-delay: 0.25s; }
        .search-result-item:nth-child(5) { animation-delay: 0.3s; }

        @keyframes slideInUp {
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .search-result-item:hover {
            background: var(--item-hover-bg);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .search-result-item.album:hover {
            transform: translateY(-4px);
        }

        .search-result-info {
            flex: 1;
            min-width: 0;
        }

        .search-result-title {
            font-weight: 600;
            color: var(--text-color);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 15px;
            margin-bottom: 4px;
        }

        .search-result-artist {
            font-size: 13px;
            color: var(--text-secondary-color);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .search-result-actions {
            display: flex;
            gap: 8px;
            margin-left: 15px;
        }

        .action-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            position: relative;
            z-index: 10000;
            font-weight: 500;
        }

        .action-btn:hover {
            background: var(--primary-color-dark);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(26, 188, 156, 0.3);
        }

        .action-btn.download {
            background: var(--success-color);
            padding: 4px 8px;
            font-size: 10px;
        }

        .action-btn.download:hover {
            background: #27ae60;
            box-shadow: 0 4px 12px rgba(46, 204, 113, 0.3);
        }

        /* 主要内容区域 - 播放模式显示，搜索模式隐藏 */
        .main-content {
            display: contents;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .container.search-mode .main-content {
            display: none;
        }

        /* 音乐封面区域 */
        .cover-area {
            grid-area: cover;
            background: var(--component-bg);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            box-sizing: border-box;
            height: 100%;
            overflow-y: auto;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .album-cover {
            width: 200px;
            height: auto;
            flex-grow: 1;
            border-radius: 12px;
            background: linear-gradient(45deg, var(--primary-color), var(--success-color));
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .album-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 12px;
        }

        .album-cover.loading {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .album-cover .placeholder {
            font-size: 48px;
            color: white;
            opacity: 0.8;
        }

        .current-song-info {
            width: 100%;
        }

        .current-song-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .current-song-artist {
            font-size: 14px;
            color: var(--text-secondary-color);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* 播放列表和歌词区域 */
        .playlist, .lyrics { 
            background: var(--component-bg); 
            border-radius: 16px; 
            padding: 20px; 
            border: 1px solid var(--border-color); 
            height: 100%; 
            overflow-y: auto;
            min-width: 0;
            max-width: 100%;
            max-height: 100%;
            box-sizing: border-box;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .playlist {
            grid-area: playlist;
            background: var(--component-bg);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid var(--border-color);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            height: 100%;
            box-sizing: border-box;
        }
        
        /* 当播放列表有内容时，调整布局 */
        .playlist:not(.empty) {
            align-items: flex-start;
            justify-content: flex-start;
            display: block;
            padding-top: 50px; /* Add padding to make space for the clear button */
        }
        
        /* 播放列表空状态的提示文本 */
        .playlist.empty::before {
            content: "点击\"探索雷达\"加载在线音乐";
            color: var(--text-secondary-color);
            font-style: italic;
            opacity: 0.7;
            font-size: 0.9em;
        }

        /* 清空播放列表按钮 */
        .clear-playlist-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(255, 59, 48, 0.8);
            border: none;
            border-radius: 6px;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            color: white;
            font-size: 12px;
            z-index: 1000;
        }

        .clear-playlist-btn:hover {
            background: rgba(255, 59, 48, 1);
            transform: scale(1.05);
        }

        .clear-playlist-btn:active {
            transform: scale(0.95);
        }

        .lyrics {
            grid-area: lyrics;
        }
        
        .playlist-items {
            width: 100%;
        }

        .playlist.empty .clear-playlist-btn {
            display: none;
        }

        .playlist-items .playlist-item {
            padding: 10px 12px;
            border-radius: 8px;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            position: relative;
            font-size: 14px;
            margin-bottom: 2px;
        }
        .playlist-items .playlist-item:hover {
            background-color: var(--item-hover-bg);
            color: var(--item-current-text);
            transform: translateX(5px);
        }
        .playlist-items .playlist-item.current {
            color: var(--item-current-text);
            font-weight: 500;
            background-color: var(--item-current-bg);
        }
        
        /* 播放列表项下载按钮 - 修复大小和显示问题 */
        .playlist-item-download {
            position: absolute;
            right: 35px; /* Adjusted position */
            top: 50%;
            transform: translateY(-50%);
            background: var(--success-color);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px;
            font-size: 10px;
            cursor: pointer;
            opacity: 0;
            transition: all 0.2s ease;
            z-index: 1000;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .playlist-items .playlist-item:hover .playlist-item-download {
            opacity: 1;
        }

        .playlist-item-download:hover {
            background: var(--success-color-hover);
            transform: translateY(-50%) scale(1.05);
        }

        /* 播放列表项删除按钮 */
        .playlist-item-remove {
            position: absolute;
            right: 8px; /* Adjusted position */
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 59, 48, 0.8);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px;
            font-size: 10px;
            cursor: pointer;
            opacity: 0;
            transition: all 0.2s ease;
            z-index: 1000;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .playlist-items .playlist-item:hover .playlist-item-remove {
            opacity: 1;
        }

        .playlist-item-remove:hover {
            background: rgba(255, 59, 48, 1);
            transform: translateY(-50%) scale(1.05);
        }
        /* 动态质量菜单样式 */
        .dynamic-quality-menu {
            background: var(--component-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 8px 0;
            min-width: 150px;
            animation: fadeIn 0.2s ease;
        }
        
        .dynamic-quality-menu .quality-option {
            padding: 8px 16px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            font-size: 14px;
            color: var(--text-color);
        }
        
        .dynamic-quality-menu .quality-option:hover {
            background: var(--primary-color);
            color: white;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .lyrics { 
            grid-area: lyrics;
            text-align: center; 
            font-size: 1em; 
            line-height: 2;
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        /* 当歌词容器有内容时的样式 */
        .lyrics:not(.empty) {
            align-items: flex-start;
            justify-content: flex-start;
        }
        
        .lyrics div { 
            white-space: pre-wrap; 
            padding: 5px;
            margin-bottom: 5px;
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-width: 100%;
        }
        
        /* 当歌词容器只有默认文本时的样式 */
        .lyrics:empty::before,
        .lyrics.empty::before {
            content: "歌词将在此处同步显示";
            color: var(--text-secondary-color);
            font-style: italic;
            opacity: 0.7;
            font-size: 0.9em;
        }
        .lyrics .current { 
            color: var(--lyrics-highlight-text); 
            font-weight: 700; 
            background-color: var(--lyrics-highlight-bg); 
            transform: scale(1.05); 
            box-shadow: 0 4px 15px var(--lyrics-highlight-shadow); 
        }

        /* 控制区域 */
        .controls {
            grid-area: controls;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .controls button {
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em; 
            width: 50px; 
            height: 50px; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            transition: all 0.2s ease; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); 
        }
        .controls button:hover { 
            background: var(--primary-color-dark); 
            transform: translateY(-2px); 
            box-shadow: 0 6px 15px rgba(0,0,0,0.15); 
        }
        .controls button:active { 
            transform: translateY(0); 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
        }
        .controls button#loadOnlineBtn { 
            width: auto; 
            border-radius: 25px; 
            padding: 0 25px; 
            gap: 10px; 
        }
        .controls button:disabled { 
            background: var(--text-secondary-color); 
            cursor: not-allowed; 
            transform: none; 
            box-shadow: none; 
        }
        .transport-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        #playPauseBtn {
            width: 60px;
            height: 60px;
            font-size: 1.4em;
        }

        .progress-container {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1 1 320px;
            min-width: 260px;
        }

        .progress-container span {
            font-variant-numeric: tabular-nums;
            font-size: 0.85em;
            color: var(--text-secondary-color);
        }

        .progress-container input[type="range"] {
            flex: 1;
            height: 8px;
            border-radius: 999px;
            background: linear-gradient(to right, var(--primary-color) 0%, var(--primary-color) var(--progress, 0%), rgba(255, 255, 255, 0.5) var(--progress, 0%), rgba(255, 255, 255, 0.2) 100%);
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .audio-tools {
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .volume-container {
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 140px;
        }

        .volume-container input[type="range"] {
            width: 120px;
            height: 6px;
            border-radius: 999px;
            background: linear-gradient(to right, var(--primary-color) 0%, var(--primary-color) var(--volume-progress, 100%), rgba(255, 255, 255, 0.2) var(--volume-progress, 100%), rgba(255, 255, 255, 0.1) 100%);
            cursor: pointer;
        }

        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            background: transparent;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--primary-color);
            border: 2px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s ease;
        }

        input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--primary-color);
            border: 2px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s ease;
        }

        input[type="range"]:active::-webkit-slider-thumb,
        input[type="range"]:active::-moz-range-thumb {
            transform: scale(1.1);
        }

        .player-quality {
            position: relative;
        }

        .controls .player-quality-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0;
            padding: 10px 16px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: var(--component-bg);
            color: var(--text-color);
            font-size: 0.9em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            width: auto;
            height: auto;
            box-shadow: none;
        }

        .controls .player-quality-btn:hover,
        .controls .player-quality-btn.active {
            border-color: var(--primary-color);
            color: var(--primary-color);
            box-shadow: 0 6px 16px rgba(26, 188, 156, 0.25);
            background: var(--component-bg);
        }

        .player-quality-menu {
            position: absolute;
            top: calc(100% + 10px);
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            box-shadow: 0 12px 30px rgba(0,0,0,0.2);
            border: 1px solid var(--border-color);
            min-width: 180px;
            overflow: hidden;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s ease;
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            z-index: 100000;
            pointer-events: none;
        }

        .player-quality-menu.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
            pointer-events: auto;
        }

        .player-quality-menu.floating {
            position: fixed;
            right: auto;
            left: 0;
            top: 0;
            will-change: opacity, transform;
        }

        .player-quality-menu.floating:not(.show) {
            opacity: 0;
            visibility: hidden;
        }

        .player-quality-menu.open-upwards {
            transform-origin: bottom center;
        }

        .player-quality-menu.open-downwards {
            transform-origin: top center;
        }

        .player-quality-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 14px;
            font-size: 0.9em;
            color: var(--text-color);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .player-quality-option:hover,
        .player-quality-option.active {
            background: var(--primary-color);
            color: white;
        }

        .player-quality-option small {
            opacity: 0.7;
        }

        #audioPlayer {
            position: absolute;
            width: 0;
            height: 0;
            opacity: 0;
            pointer-events: none;
        }

        /* 播放模式控制按钮 */
        .play-mode-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .play-mode-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em;
            width: 50px;
            height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.2s ease;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .play-mode-btn:hover {
            background: var(--primary-color);
            color: white;
            transform: translateY(-1px);
        }

        .play-mode-btn.active {
            background: var(--primary-color);
            color: white;
        }

        /* 下载质量选择菜单 - 修复层级和显示问题 */
        .quality-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid var(--primary-color);
            border-radius: 8px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.25);
            z-index: 999999;
            min-width: 120px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s ease;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            pointer-events: none;
        }

        /* 确保搜索结果项在质量菜单显示时不会遮挡 */
        .search-result-item {
            position: relative;
            z-index: 1;
        }

        .search-result-item:has(.quality-menu.show) {
            z-index: 1000000;
        }

        /* 为不支持 :has() 的浏览器提供备用方案 */
        .search-result-item.menu-active {
            z-index: 1000000;
        }

        .quality-menu.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
            pointer-events: auto;
        }

        .quality-option {
            padding: 6px 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 10px;
            font-weight: 500;
            color: var(--text-color);
            background: rgba(255, 255, 255, 0.8);
            border-bottom: 1px solid rgba(26, 188, 156, 0.18);
        }

        .quality-option:hover {
            background: var(--primary-color);
            color: white;
            transform: translateX(2px);
        }

        .quality-option:first-child {
            border-radius: 6px 6px 0 0;
        }

        .quality-option:last-child {
            border-radius: 0 0 6px 6px;
            border-bottom: none;
        }

        /* 加载更多按钮 - 增强样式 */
        .load-more-btn {
            width: 100%;
            background: var(--component-bg);
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            margin-top: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            position: relative;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .load-more-btn:hover {
            background: var(--primary-color);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(26, 188, 156, 0.35);
        }

        .load-more-btn:disabled {
            background: var(--text-secondary-color);
            border-color: var(--text-secondary-color);
            color: white;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* 调试信息样式 */
        .debug-info {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 10000;
            max-width: 300px;
            display: none;
        }

        .debug-info.show {
            display: block;
        }
        
        .loader { 
            width: 20px; 
            height: 20px; 
            border: 3px solid var(--primary-color); 
            border-bottom-color: transparent; 
            border-radius: 50%; 
            display: inline-block; 
            box-sizing: border-box; 
            animation: rotation 1s linear infinite; 
        }
        @keyframes rotation { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
        
        .theme-switch-wrapper {
            position: absolute;
            top: 0px;
            right: 0px;
            display: flex;
            justify-content: flex-end;
        }

        .theme-toggle-button {
            width: 44px;
            height: 44px;
            border-radius: 16px;
            border: 1px solid var(--border-color);
            background: linear-gradient(160deg, rgba(255, 255, 255, 0.85), rgba(255, 255, 255, 0.4));
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease, background 0.3s ease;
            position: relative;
            overflow: hidden;
            color: var(--primary-color);
        }

        .theme-toggle-button:focus-visible {
            outline: none;
            box-shadow: 0 0 0 4px rgba(26, 188, 156, 0.25);
        }

        .theme-toggle-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 26px rgba(0, 0, 0, 0.16);
        }

        .theme-toggle-button.is-dark {
            background: linear-gradient(160deg, rgba(36, 42, 54, 0.9), rgba(24, 30, 42, 0.7));
            border-color: rgba(26, 188, 156, 0.45);
        }

        .theme-toggle-button .theme-icon {
            position: absolute;
            font-size: 18px;
            transition: opacity 0.35s ease, transform 0.45s ease;
            opacity: 0;
            transform: scale(0.6) rotate(-20deg);
        }

        .theme-toggle-button .theme-icon--sun {
            color: #f5a623;
            text-shadow: 0 0 10px rgba(245, 166, 35, 0.4);
        }

        .theme-toggle-button .theme-icon--moon {
            color: #a29bfe;
            text-shadow: 0 0 10px rgba(162, 155, 254, 0.4);
            transform: scale(0.6) rotate(20deg);
        }

        .theme-toggle-button:not(.is-dark) .theme-icon--sun {
            opacity: 1;
            transform: scale(1) rotate(0deg);
        }

        .theme-toggle-button.is-dark .theme-icon--moon {
            opacity: 1;
            transform: scale(1) rotate(0deg);
        }

        /* 专辑详情覆盖层 */
        .album-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.45);
            backdrop-filter: blur(18px);
            -webkit-backdrop-filter: blur(18px);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.35s ease;
            z-index: 1200;
        }

        .album-overlay::before {
            content: "";
            position: absolute;
            inset: 0;
            background-image: var(--album-backdrop-image, none);
            background-size: cover;
            background-position: center;
            filter: blur(120px);
            opacity: 0.25;
            transform: scale(1.1);
            transition: opacity 0.35s ease;
        }

        .album-overlay.show {
            opacity: 1;
            pointer-events: auto;
        }

        .album-detail-panel {
            position: relative;
            width: min(860px, 95vw);
            max-height: min(80vh, 700px);
            background: rgba(255, 255, 255, 0.65);
            border-radius: 24px;
            padding: 30px;
            box-shadow: 0 30px 80px rgba(0,0,0,0.25);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            gap: 24px;
            z-index: 1;
            border: 1px solid rgba(26, 188, 156, 0.2);
        }

        .dark-mode .album-detail-panel {
            background: rgba(30, 30, 30, 0.7);
            border-color: rgba(26, 188, 156, 0.35);
        }

        .album-overlay-close {
            position: absolute;
            top: 18px;
            right: 18px;
            width: 40px;
            height: 40px;
            border-radius: 14px;
            border: 1px solid rgba(255, 255, 255, 0.35);
            background: rgba(0, 0, 0, 0.25);
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            z-index: 2;
        }

        .album-overlay-close:hover {
            transform: translateY(-2px);
            background: var(--primary-color);
            border-color: transparent;
        }

        .album-hero {
            display: grid;
            grid-template-columns: 220px 1fr;
            gap: 28px;
            align-items: center;
        }

        .album-hero-cover {
            position: relative;
            width: 220px;
            height: 220px;
            border-radius: 24px;
            overflow: hidden;
            box-shadow: 0 25px 60px rgba(0,0,0,0.25);
            background: rgba(255,255,255,0.4);
            border: 1px solid rgba(26, 188, 156, 0.25);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .album-hero-cover.loading::after {
            content: "";
            position: absolute;
            inset: 0;
            background: linear-gradient(130deg, rgba(255,255,255,0.1), rgba(255,255,255,0.35));
            animation: shimmer 1.2s ease-in-out infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .album-hero-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .album-hero-info {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .album-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 14px;
            border-radius: 999px;
            background: rgba(26, 188, 156, 0.18);
            color: var(--primary-color);
            font-weight: 600;
            width: fit-content;
            letter-spacing: 0.5px;
        }

        .album-hero-title {
            font-size: 1.8em;
            font-weight: 700;
            margin: 0;
            color: var(--text-color);
        }

        .album-hero-artist {
            font-size: 1.1em;
            color: var(--text-secondary-color);
        }

        .album-hero-meta {
            font-size: 0.95em;
            color: var(--text-secondary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .album-hero-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 10px;
        }

        .album-hero-actions .action-btn {
            font-size: 14px;
            padding: 10px 20px;
            border-radius: 12px;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }

        .album-hero-actions .action-btn.secondary {
            background: rgba(255,255,255,0.4);
            color: var(--primary-color);
            border: 1px solid rgba(26, 188, 156, 0.35);
        }

        .dark-mode .album-hero-actions .action-btn.secondary {
            background: rgba(30, 30, 30, 0.6);
            color: #ecf0f1;
        }

        .album-tracklist {
            flex: 1;
            overflow-y: auto;
            padding-right: 6px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .album-tracklist::-webkit-scrollbar {
            width: 6px;
        }

        .album-tracklist::-webkit-scrollbar-thumb {
            background: rgba(0,0,0,0.2);
            border-radius: 3px;
        }

        .dark-mode .album-tracklist::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.18);
        }

        .album-track-row {
            display: grid;
            grid-template-columns: 40px 1fr auto;
            align-items: center;
            padding: 12px 16px;
            background: rgba(255,255,255,0.55);
            border-radius: 14px;
            border: 1px solid rgba(26, 188, 156, 0.12);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .album-track-row:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 28px rgba(0,0,0,0.12);
        }

        .dark-mode .album-track-row {
            background: rgba(30, 30, 30, 0.65);
            border-color: rgba(26, 188, 156, 0.18);
        }

        .album-track-row.in-playlist {
            border-color: var(--primary-color);
            box-shadow: 0 12px 24px rgba(26,188,156,0.2);
        }

        .album-track-index {
            font-weight: 600;
            color: var(--text-secondary-color);
            font-size: 0.95em;
        }

        .album-track-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .album-track-title {
            font-weight: 600;
            color: var(--text-color);
        }

        .album-track-artist {
            font-size: 0.9em;
            color: var(--text-secondary-color);
        }

        .album-track-actions {
            display: flex;
            gap: 8px;
        }

        .album-track-actions .action-btn {
            padding: 6px 10px;
            border-radius: 10px;
            font-size: 12px;
            min-width: unset;
        }

        .album-track-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 30px 0;
            color: var(--text-secondary-color);
            gap: 12px;
        }

        .album-track-loading .loader {
            border-width: 3px;
            width: 26px;
            height: 26px;
        }

        .album-empty-placeholder {
            padding: 40px 0;
            text-align: center;
            color: var(--text-secondary-color);
        }

        @media (max-width: 768px) {
            .album-detail-panel {
                padding: 24px 18px;
                max-height: none;
                height: 95vh;
            }

            .album-hero {
                grid-template-columns: 1fr;
                justify-items: center;
                text-align: center;
            }

            .album-hero-cover {
                width: 180px;
                height: 180px;
            }

            .album-hero-info {
                align-items: center;
            }

            .album-hero-actions {
                justify-content: center;
            }

            .album-track-row {
                grid-template-columns: 32px 1fr;
                grid-template-rows: auto auto;
                gap: 10px;
            }

            .album-track-actions {
                grid-column: 1 / -1;
                justify-content: center;
            }
        }

        /* 通知样式 */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--success-color);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            background: var(--warning-color);
        }

        .notification.warning {
            background: #f39c12;
        }

        /* 视图切换按钮 - 桌面端隐藏，移动端显示 */
        .view-toggle { 
            display: none;
        }

        /* 移动端适配 */
        @media (max-width: 1024px) {
            .container {
                grid-template-areas: 
                    "header header"
                    "search search"
                    "cover cover"
                    "playlist lyrics"
                    "controls controls";
                grid-template-columns: 1fr 1fr;
                grid-template-rows: auto auto auto 1fr auto;
                aspect-ratio: auto;
                height: 90vh;
            }

            .container.search-mode {
                grid-template-areas: 
                    "header header"
                    "search search"
                    "search search"
                    "controls controls";
            }

            .cover-area {
                flex-direction: row;
                gap: 20px;
            }

            .album-cover {
                width: 120px;
                height: 120px;
                margin-bottom: 0;
            }

            .current-song-info {
                flex: 1;
                text-align: left;
            }
        }

        @media (max-width: 768px) {
            body { 
                padding: 0; 
            }
            .container {
                padding: 15px;
                gap: 15px;
                grid-template-areas: 
                    "header"
                    "search"
                    "cover"
                    "view-toggle"
                    "playlist"
                    "controls";
                grid-template-columns: 1fr;
                grid-template-rows: auto auto auto auto 1fr auto;
                border-radius: 0;
                border: none;
                height: 100vh;
                max-height: none;
                aspect-ratio: auto;
            }

            .container.search-mode {
                grid-template-areas: 
                    "header"
                    "search"
                    "search"
                    "controls";
                grid-template-rows: auto auto 1fr auto;
            }

            .header h1 { 
                font-size: 1.8em; 
            }
            .search-area { 
                padding: 15px; 
            }
            .search-container { 
                flex-direction: column; 
                gap: 10px; 
            }
            .search-input, .search-btn, .source-select-wrapper {
                width: 100%;
            }

            .source-select-btn {
                width: 100%;
                justify-content: space-between;
            }

            .cover-area {
                flex-direction: column;
                padding: 15px;
            }

            .album-cover {
                width: 150px;
                height: 150px;
                margin-bottom: 15px;
            }

            .current-song-info {
                text-align: center;
            }
            
            .view-toggle { 
                grid-area: view-toggle;
                display: flex; 
                gap: 10px; 
            }
            .view-toggle button { 
                flex: 1; 
                padding: 10px; 
                border: 2px solid var(--primary-color); 
                background: var(--component-bg); 
                color: var(--primary-color); 
                border-radius: 8px; 
                cursor: pointer; 
                transition: all 0.2s ease; 
            }
            .view-toggle button.active { 
                background: var(--primary-color); 
                color: white; 
            }
            
            .playlist, .lyrics { 
                display: none; 
                height: 100%; 
            }
            .playlist.active, .lyrics.active { 
                display: block; 
            }
            
            .controls {
                gap: 15px;
            }
            .transport-controls {
                width: 100%;
                justify-content: center;
            }
            .progress-container {
                flex: 1 1 100%;
                min-width: 100%;
            }
            .audio-tools {
                width: 100%;
                justify-content: space-between;
                gap: 12px;
            }
            .volume-container {
                flex: 1;
                min-width: 0;
            }
            .volume-container input[type="range"] {
                width: 100%;
            }
        }
    </style>
</head>
<body>
<div class="container" id="mainContainer">
    <div class="header">
        <h1>音乐播放器</h1>
        <div class="warning">免费API来自GD音乐台(music.gdstudio.xyz)，仅供学习交流使用，请支持正版音乐奥。</div>
        <div class="theme-switch-wrapper">
            <button id="themeToggleButton" class="theme-toggle-button" type="button" aria-label="切换深浅色模式">
                <i class="fas fa-sun theme-icon theme-icon--sun" aria-hidden="true"></i>
                <i class="fas fa-moon theme-icon theme-icon--moon" aria-hidden="true"></i>
            </button>
        </div>
    </div>

    <div class="search-area">
        <div class="search-container">
            <input type="text" id="searchInput" class="search-input" placeholder="搜索歌曲、歌手或专辑...">
            <div class="source-select-wrapper" id="sourceSelectWrapper">
                <button id="sourceSelectButton" class="source-select-btn" type="button" aria-haspopup="listbox" aria-expanded="false">
                    <span id="sourceSelectLabel">网易云音乐</span>
                    <i class="fas fa-chevron-down caret-icon" aria-hidden="true"></i>
                </button>
                <div id="sourceMenu" class="source-menu" role="listbox" aria-labelledby="sourceSelectButton"></div>
            </div>
            <button id="searchBtn" class="search-btn">
                <i class="fas fa-search"></i>
                <span>搜索</span>
            </button>
        </div>
        <div id="searchResults" class="search-results"></div>
    </div>

    <div class="main-content">
        <div class="cover-area">
            <div class="album-cover" id="albumCover">
                <div class="placeholder">
                    <i class="fas fa-music"></i>
                </div>
            </div>
            <div class="current-song-info">
                <div class="current-song-title" id="currentSongTitle">选择一首歌曲开始播放</div>
                <div class="current-song-artist" id="currentSongArtist">未知艺术家</div>
            </div>
        </div>

        <div class="view-toggle">
            <button id="showPlaylistBtn" class="active">播放列表</button>
            <button id="showLyricsBtn">歌词</button>
        </div>

        <div class="playlist active empty" id="playlist">
            <button class="clear-playlist-btn" id="clearPlaylistBtn" onclick="clearPlaylist()" title="清空播放列表">
                <i class="fas fa-trash"></i>
            </button>
            <div class="playlist-items" id="playlistItems"></div>
        </div>
        <div class="lyrics" id="lyrics"></div>
    </div>

    <div class="controls">
        <div class="play-mode-controls">
            <button class="play-mode-btn" id="playModeBtn" title="播放模式">
                <i class="fas fa-repeat"></i>
            </button>
        </div>
        <div class="transport-controls">
            <button onclick="playPrevious()" title="上一曲"><i class="fas fa-backward-step"></i></button>
            <button id="playPauseBtn" title="播放 / 暂停"><i class="fas fa-play"></i></button>
            <button onclick="playNext()" title="下一曲"><i class="fas fa-forward-step"></i></button>
        </div>
        <div class="progress-container">
            <span id="currentTimeDisplay">00:00</span>
            <input type="range" id="progressBar" min="0" max="0" step="0.1" value="0">
            <span id="durationDisplay">00:00</span>
        </div>
        <div class="audio-tools">
            <div class="player-quality">
                <button id="qualityToggle" class="player-quality-btn" type="button">
                    <span id="qualityLabel">极高音质</span>
                </button>
                <div id="playerQualityMenu" class="player-quality-menu"></div>
            </div>
            <div class="volume-container">
                <i id="volumeIcon" class="fas fa-volume-up"></i>
                <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="0.8">
            </div>
        </div>
        <button id="loadOnlineBtn" title="聚合所有雷达，探索新音乐">
            <span class="btn-text"><i class="fas fa-satellite-dish"></i> 探索雷达</span>
            <span class="loader" style="display: none;"></span>
        </button>
    </div>
</div>

<div id="albumDetailOverlay" class="album-overlay" aria-hidden="true">
    <div class="album-detail-panel" role="dialog" aria-modal="true" aria-labelledby="albumHeroTitle">
        <button id="closeAlbumOverlay" class="album-overlay-close" type="button" aria-label="关闭专辑详情">
            <i class="fas fa-times"></i>
        </button>
        <div class="album-hero">
            <div class="album-hero-cover" id="albumHeroCover">
                <div class="placeholder">
                    <i class="fas fa-compact-disc"></i>
                </div>
            </div>
            <div class="album-hero-info">
                <span class="album-badge"><i class="fas fa-compact-disc"></i> 专辑</span>
                <h2 class="album-hero-title" id="albumHeroTitle">精选专辑</h2>
                <div class="album-hero-artist" id="albumHeroArtist">未知艺人</div>
                <div class="album-hero-meta" id="albumHeroMeta"></div>
                <div class="album-hero-actions">
                    <button id="playAlbumBtn" class="action-btn play" type="button">
                        <i class="fas fa-play"></i>
                        播放整张专辑
                    </button>
                    <button id="addAlbumBtn" class="action-btn secondary" type="button">
                        <i class="fas fa-plus"></i>
                        添加到播放列表
                    </button>
                </div>
            </div>
        </div>
        <div class="album-tracklist" id="albumTrackList">
            <div class="album-empty-placeholder">从搜索结果中选择一张专辑，体验沉浸式播放。</div>
        </div>
    </div>
</div>

<audio id="audioPlayer"></audio>

<!-- 通知容器 -->
<div id="notification" class="notification"></div>

<!-- 调试信息容器 -->
<div id="debugInfo" class="debug-info"></div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    const dom = {
        container: document.getElementById("mainContainer"),
        playlist: document.getElementById("playlist"),
        playlistItems: document.getElementById("playlistItems"),
        lyrics: document.getElementById("lyrics"),
        audioPlayer: document.getElementById("audioPlayer"),
        themeToggleButton: document.getElementById("themeToggleButton"),
        loadOnlineBtn: document.getElementById("loadOnlineBtn"),
        showPlaylistBtn: document.getElementById("showPlaylistBtn"),
        showLyricsBtn: document.getElementById("showLyricsBtn"),
        searchInput: document.getElementById("searchInput"),
        searchBtn: document.getElementById("searchBtn"),
        sourceSelectButton: document.getElementById("sourceSelectButton"),
        sourceSelectLabel: document.getElementById("sourceSelectLabel"),
        sourceMenu: document.getElementById("sourceMenu"),
        searchResults: document.getElementById("searchResults"),
        notification: document.getElementById("notification"),
        albumCover: document.getElementById("albumCover"),
        currentSongTitle: document.getElementById("currentSongTitle"),
        currentSongArtist: document.getElementById("currentSongArtist"),
        debugInfo: document.getElementById("debugInfo"),
        playModeBtn: document.getElementById("playModeBtn"),
        playPauseBtn: document.getElementById("playPauseBtn"),
        progressBar: document.getElementById("progressBar"),
        currentTimeDisplay: document.getElementById("currentTimeDisplay"),
        durationDisplay: document.getElementById("durationDisplay"),
        volumeSlider: document.getElementById("volumeSlider"),
        volumeIcon: document.getElementById("volumeIcon"),
        qualityToggle: document.getElementById("qualityToggle"),
        playerQualityMenu: document.getElementById("playerQualityMenu"),
        qualityLabel: document.getElementById("qualityLabel"),
        albumOverlay: document.getElementById("albumDetailOverlay"),
        albumHeroCover: document.getElementById("albumHeroCover"),
        albumHeroTitle: document.getElementById("albumHeroTitle"),
        albumHeroArtist: document.getElementById("albumHeroArtist"),
        albumHeroMeta: document.getElementById("albumHeroMeta"),
        albumTrackList: document.getElementById("albumTrackList"),
        closeAlbumOverlayBtn: document.getElementById("closeAlbumOverlay"),
        playAlbumBtn: document.getElementById("playAlbumBtn"),
        addAlbumBtn: document.getElementById("addAlbumBtn"),
    };

    function safeGetLocalStorage(key) {
        try {
            return localStorage.getItem(key);
        } catch (error) {
            console.warn(`读取本地存储失败: ${key}`, error);
            return null;
        }
    }

    function safeSetLocalStorage(key, value) {
        try {
            localStorage.setItem(key, value);
        } catch (error) {
            console.warn(`写入本地存储失败: ${key}`, error);
        }
    }

    function parseJSON(value, fallback) {
        if (!value) return fallback;
        try {
            const parsed = JSON.parse(value);
            return parsed;
        } catch (error) {
            console.warn("解析本地存储 JSON 失败", error);
            return fallback;
        }
    }

    function preferHttpsUrl(url) {
        if (!url || typeof url !== "string") return url;

        try {
            const parsedUrl = new URL(url, window.location.href);
            if (parsedUrl.protocol === "http:" && window.location.protocol === "https:") {
                parsedUrl.protocol = "https:";
                return parsedUrl.toString();
            }
            return parsedUrl.toString();
        } catch (error) {
            if (window.location.protocol === "https:" && url.startsWith("http://")) {
                return "https://" + url.substring("http://".length);
            }
            return url;
        }
    }

    function buildAudioProxyUrl(url) {
        if (!url || typeof url !== "string") return url;

        try {
            const parsedUrl = new URL(url, window.location.href);
            if (parsedUrl.protocol === "https:") {
                return parsedUrl.toString();
            }

            if (parsedUrl.protocol === "http:" && /(^|\.)kuwo\.cn$/i.test(parsedUrl.hostname)) {
                return `${API.baseUrl}?target=${encodeURIComponent(parsedUrl.toString())}`;
            }

            return parsedUrl.toString();
        } catch (error) {
            console.warn("无法解析音频地址，跳过代理", error);
            return url;
        }
    }

    const SOURCE_OPTIONS = [
        { value: "netease", label: "网易云音乐" },
        { value: "kuwo", label: "酷我音乐" },
        { value: "joox", label: "JOOX音乐" }
    ];

    function normalizeSource(value) {
        const allowed = SOURCE_OPTIONS.map(option => option.value);
        return allowed.includes(value) ? value : SOURCE_OPTIONS[0].value;
    }

    function safeNormalizeSource(value) {
        if (Array.isArray(value)) {
            value = value[0];
        }
        if (!value) return SOURCE_OPTIONS[0].value;
        const candidate = String(value).split(',')[0].trim();
        return normalizeSource(candidate);
    }

    function normalizeArtists(value) {
        const names = [];
        const push = (name) => {
            if (!name) return;
            const trimmed = String(name).trim();
            if (trimmed && !names.includes(trimmed)) {
                names.push(trimmed);
            }
        };

        const visit = (input) => {
            if (!input) return;
            if (Array.isArray(input)) {
                input.forEach(item => visit(item));
            } else if (typeof input === "string") {
                input.split(/[,/&]|，|、|\s{2,}/).forEach(part => push(part));
            } else if (typeof input === "object") {
                const possible = [input.name, input.artist, input.nickname, input.title, input.alias];
                possible.forEach(value => visit(value));
            }
        };

        visit(value);
        return names;
    }

    function extractCoverUrl(item) {
        if (!item || typeof item !== "object") return null;
        const candidates = [
            item.cover,
            item.coverUrl,
            item.pic,
            item.picUrl,
            item.pic_url,
            item.albumpic,
            item.image,
            item.albumPic,
            item.album_cover,
            item.albumCover,
            item.img,
        ];
        return candidates.find(url => typeof url === "string" && url.startsWith("http")) || null;
    }

    function normalizeTrackData(track, albumMeta = {}) {
        if (!track) return null;

        const id = track.id ?? track.songid ?? track.songId ?? track.musicid ?? track.mid ?? track.rid ?? track.sid ?? track.hash;
        const name = track.name ?? track.songname ?? track.songName ?? track.title ?? track.song ?? track.musicName;
        if (!id || !name) return null;

        const artists = normalizeArtists(
            track.artist ?? track.artists ?? track.artistname ?? track.artistName ??
            track.singer ?? track.singers ?? track.singername ?? track.singerName
        );

        const artistValue = (() => {
            if (artists.length === 0) {
                const albumArtist = albumMeta.artist;
                if (Array.isArray(albumArtist)) {
                    return albumArtist.length === 1 ? albumArtist[0] : albumArtist;
                }
                if (albumArtist) return albumArtist;
                return "未知艺术家";
            }
            return artists.length === 1 ? artists[0] : artists;
        })();

        const albumName = track.album ?? track.albumname ?? track.albumName ?? track.al ?? albumMeta.name ?? albumMeta.album;
        const lyricId = track.lyric_id ?? track.lyricId ?? track.lrc ?? track.lrcid ?? id;
        const urlId = track.url_id ?? track.urlId ?? track.mid ?? track.hash ?? id;
        const picId = track.pic_id ?? track.picId ?? track.album_pic ?? track.albumPic ?? track.al?.picId ?? albumMeta.pic_id ?? albumMeta.picId;
        const source = safeNormalizeSource(track.source ?? track.platform ?? track.vendor ?? albumMeta.source ?? albumMeta.albumSource);

        return {
            type: "song",
            id,
            name,
            artist: artistValue,
            album: albumName,
            pic_id: picId,
            lyric_id: lyricId,
            url_id: urlId,
            source,
        };
    }

    function extractAlbumYear(publishTime) {
        if (!publishTime) return "";
        let date;
        if (typeof publishTime === "number") {
            date = publishTime > 1e12 ? new Date(publishTime) : new Date(publishTime * 1000);
        } else {
            date = new Date(publishTime);
        }
        if (Number.isNaN(date.getTime())) return "";
        return String(date.getFullYear());
    }

    function normalizeApiItem(item) {
        if (!item) return null;

        const itemType = (item.type || item.kind || item.category || "").toString().toLowerCase();
        const albumPayload = item._album || (item.source === "_album" ? item : null) || (itemType === "album" ? item : null);

        if (albumPayload) {
            const albumData = albumPayload.album || albumPayload.data || albumPayload;
            const albumId = albumData.id ?? albumData.album_id ?? albumData.albumId ?? albumData.mid ?? item.id;
            const albumSource = safeNormalizeSource(albumData.source ?? albumData.platform ?? albumData.vendor ?? item.real_source ?? item.source);
            const albumName = albumData.name ?? albumData.album ?? item.name ?? "未知专辑";
            const albumArtists = normalizeArtists(albumData.artist ?? albumData.artists ?? albumData.artist_name ?? item.artist);
            const artistValue = albumArtists.length === 0
                ? (Array.isArray(item.artist) ? item.artist : item.artist || "未知艺术家")
                : (albumArtists.length === 1 ? albumArtists[0] : albumArtists);
            const albumPicId = albumData.pic_id ?? albumData.picId ?? albumData.pic ?? albumData.coverId ?? item.pic_id;
            const coverUrl = extractCoverUrl(albumData) || extractCoverUrl(item);
            const publishTime = albumData.publishTime ?? albumData.pubtime ?? albumData.publish_time ?? albumData.releaseDate ?? albumData.release_time;
            const year = extractAlbumYear(publishTime);

            const baseAlbumMeta = {
                id: albumId,
                name: albumName,
                artist: artistValue,
                pic_id: albumPicId,
                source: albumSource,
            };

            const embeddedTracks = albumData.songs || albumData.tracks || albumData.list || item.songs;
            const normalizedTracks = Array.isArray(embeddedTracks)
                ? embeddedTracks.map(track => normalizeTrackData(track, baseAlbumMeta)).filter(Boolean)
                : [];

            const fallbackTrackCount = normalizedTracks.length;
            const songCount = albumData.songCount
                ?? albumData.trackCount
                ?? albumData.size
                ?? albumData.musicSize
                ?? (fallbackTrackCount > 0 ? fallbackTrackCount : undefined);

            return {
                type: "album",
                id: albumId,
                albumId,
                name: albumName,
                artist: artistValue,
                album: albumName,
                source: albumSource,
                albumSource,
                pic_id: albumPicId,
                coverUrl,
                publishTime,
                publishYear: year,
                songCount,
                tracks: normalizedTracks,
                raw: item,
            };
        }

        const id = item.id ?? item.songid ?? item.songId ?? item.musicid ?? item.rid ?? item.mid;
        const name = item.name ?? item.title ?? item.songname ?? item.songName ?? item.musicName;
        if (!id || !name) return null;

        const artists = normalizeArtists(item.artist ?? item.artists ?? item.singer ?? item.singers ?? item.artistname ?? item.artistName);
        const artistValue = artists.length === 0 ? (item.artist || "未知艺术家") : (artists.length === 1 ? artists[0] : artists);
        const albumName = item.album ?? item.albumname ?? item.albumName;
        const picId = item.pic_id ?? item.picId ?? item.pic ?? item.picUrl ?? item.coverId;
        const lyricId = item.lyric_id ?? item.lyricId ?? item.lrc ?? id;
        const urlId = item.url_id ?? item.urlId ?? item.mid ?? id;
        const source = safeNormalizeSource(item.source ?? item.platform ?? item.vendor ?? item.channel);
        const coverUrl = extractCoverUrl(item);

        return {
            type: "song",
            id,
            name,
            artist: artistValue,
            album: albumName,
            pic_id: picId,
            url_id: urlId,
            lyric_id: lyricId,
            source,
            coverUrl,
        };
    }

    function mergeAlbumMetadata(base, incoming = {}) {
        const merged = { ...base };

        if (incoming.name || incoming.album) {
            merged.name = incoming.name || incoming.album;
        }

        const artistCandidates = incoming.artist ?? incoming.artists ?? incoming.artist_name;
        const incomingArtists = normalizeArtists(artistCandidates);
        if (incomingArtists.length > 0) {
            merged.artist = incomingArtists.length === 1 ? incomingArtists[0] : incomingArtists;
        }

        const coverUrl = extractCoverUrl(incoming);
        if (coverUrl) {
            merged.coverUrl = coverUrl;
        }

        const picId = incoming.pic_id ?? incoming.picId ?? incoming.pic ?? incoming.coverId;
        if (picId) {
            merged.pic_id = picId;
        }

        const publishTime = incoming.publishTime ?? incoming.pubtime ?? incoming.publish_time ?? incoming.releaseDate ?? incoming.release_time;
        if (publishTime) {
            merged.publishTime = publishTime;
            merged.publishYear = extractAlbumYear(publishTime);
        }

        const count = incoming.songCount ?? incoming.trackCount ?? incoming.size ?? incoming.musicSize;
        const normalizedCount = Number(count);
        if (Number.isFinite(normalizedCount) && normalizedCount > 0) {
            merged.songCount = normalizedCount;
        }

        if (incoming.source || incoming.platform || incoming.vendor) {
            merged.source = safeNormalizeSource(incoming.source ?? incoming.platform ?? incoming.vendor);
            merged.albumSource = merged.source;
        }

        return merged;
    }

    function cloneSongData(song) {
        if (!song) return null;
        const cloned = { ...song };
        if (Array.isArray(song.artist)) {
            cloned.artist = [...song.artist];
        }
        if (song.tracks && Array.isArray(song.tracks)) {
            cloned.tracks = song.tracks.map(track => cloneSongData(track)).filter(Boolean);
        }
        return cloned;
    }

    function dedupeTracks(tracks = []) {
        const seen = new Set();
        const result = [];
        tracks.forEach(track => {
            if (!track || !track.id) return;
            const source = track.source || "netease";
            const key = `${source}_${track.id}`;
            if (seen.has(key)) return;
            seen.add(key);
            result.push(cloneSongData(track));
        });
        return result;
    }

    const QUALITY_OPTIONS = [
        { value: "128", label: "标准音质", description: "128 kbps" },
        { value: "192", label: "高品音质", description: "192 kbps" },
        { value: "320", label: "极高音质", description: "320 kbps" },
        { value: "999", label: "无损音质", description: "FLAC" }
    ];

    function normalizeQuality(value) {
        const match = QUALITY_OPTIONS.find(option => option.value === value);
        return match ? match.value : "320";
    }

    const savedPlaylistSongs = (() => {
        const stored = safeGetLocalStorage("playlistSongs");
        const playlist = parseJSON(stored, []);
        return Array.isArray(playlist) ? playlist : [];
    })();

    const savedCurrentTrackIndex = (() => {
        const stored = safeGetLocalStorage("currentTrackIndex");
        const index = Number.parseInt(stored, 10);
        return Number.isInteger(index) ? index : -1;
    })();

    const savedPlayMode = (() => {
        const stored = safeGetLocalStorage("playMode");
        const modes = ["list", "single", "random"];
        return modes.includes(stored) ? stored : "list";
    })();

    const savedPlaybackQuality = normalizeQuality(safeGetLocalStorage("playbackQuality"));

    const savedVolume = (() => {
        const stored = safeGetLocalStorage("playerVolume");
        const volume = Number.parseFloat(stored);
        if (Number.isFinite(volume)) {
            return Math.min(Math.max(volume, 0), 1);
        }
        return 0.8;
    })();

    const savedSearchSource = (() => {
        const stored = safeGetLocalStorage("searchSource");
        return normalizeSource(stored);
    })();

    const savedPlaybackTime = (() => {
        const stored = safeGetLocalStorage("currentPlaybackTime");
        const time = Number.parseFloat(stored);
        return Number.isFinite(time) && time >= 0 ? time : 0;
    })();

    const savedCurrentSong = (() => {
        const stored = safeGetLocalStorage("currentSong");
        return parseJSON(stored, null);
    })();

    const savedCurrentPlaylist = (() => {
        const stored = safeGetLocalStorage("currentPlaylist");
        const playlists = ["playlist", "online", "search"];
        return playlists.includes(stored) ? stored : "playlist";
    })();
    
    // API配置 - 修复API地址和请求方式
    const API = {
        name: "GD Studio API",
        baseUrl: "/proxy",

        generateSignature: () => {
            return Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
        },

        fetchJson: async (url) => {
            try {
                const response = await fetch(url, {
                    headers: {
                        "Accept": "application/json",
                    },
                });

                if (!response.ok) {
                    throw new Error(`Request failed with status ${response.status}`);
                }

                const text = await response.text();
                try {
                    return JSON.parse(text);
                } catch (parseError) {
                    console.warn("JSON parse failed, returning raw text", parseError);
                    return text;
                }
            } catch (error) {
                console.error("API request error:", error);
                throw error;
            }
        },

        search: async (keyword, source = "netease", count = 20, page = 1) => {
            const signature = API.generateSignature();
            const url = `${API.baseUrl}?types=search&source=${source}&name=${encodeURIComponent(keyword)}&count=${count}&pages=${page}&s=${signature}`;

            try {
                debugLog(`API请求: ${url}`);
                const data = await API.fetchJson(url);
                debugLog(`API响应: ${JSON.stringify(data).substring(0, 200)}...`);

                let list = [];
                if (Array.isArray(data)) {
                    list = data;
                } else if (data && typeof data === "object") {
                    if (Array.isArray(data.result)) {
                        list = data.result;
                    } else if (Array.isArray(data.data)) {
                        list = data.data;
                    } else if (Array.isArray(data.songs)) {
                        list = data.songs;
                    }
                }

                if (!Array.isArray(list)) throw new Error("搜索结果格式错误");

                return list.map(normalizeApiItem).filter(Boolean);
            } catch (error) {
                debugLog(`API错误: ${error.message}`);
                throw error;
            }
        },

        getList: async (keyword = "热门", count = 100, pages = 1) => {
            const source = "netease,kuwo";
            const signature = API.generateSignature();
            const url = `${API.baseUrl}?types=search&source=${source}&name=${encodeURIComponent(keyword)}&count=${count}&pages=${pages}&s=${signature}`;

            try {
                const data = await API.fetchJson(url);
                let list = [];
                if (Array.isArray(data)) {
                    list = data;
                } else if (data && typeof data === "object") {
                    if (Array.isArray(data.result)) {
                        list = data.result;
                    } else if (Array.isArray(data.data)) {
                        list = data.data;
                    }
                }

                if (!Array.isArray(list) || list.length === 0) throw new Error("No songs found");
                return list.map(normalizeApiItem).filter(Boolean);
            } catch (error) {
                console.error("API request failed:", error);
                throw error;
            }
        },

        getAlbumDetail: async (album) => {
            if (!album) throw new Error("缺少专辑信息");
            const albumId = album.albumId || album.id;
            if (!albumId) throw new Error("缺少专辑ID");
            const source = safeNormalizeSource(album.albumSource || album.source || state.searchSource || "netease");
            const signature = API.generateSignature();
            const url = `${API.baseUrl}?types=source_album&id=${albumId}&source=${source}&s=${signature}`;

            const data = await API.fetchJson(url);

            let tracksRaw = [];
            let albumMeta = {};

            if (Array.isArray(data)) {
                tracksRaw = data;
            } else if (data && typeof data === "object") {
                if (Array.isArray(data.songs)) {
                    tracksRaw = data.songs;
                } else if (Array.isArray(data.tracks)) {
                    tracksRaw = data.tracks;
                } else if (Array.isArray(data.list)) {
                    tracksRaw = data.list;
                } else if (Array.isArray(data.data)) {
                    tracksRaw = data.data;
                } else if (Array.isArray(data.result)) {
                    tracksRaw = data.result;
                }

                albumMeta = data.album || data.info || data.playlist || data.data?.album || {};
            }

            const mergedAlbum = mergeAlbumMetadata({
                ...album,
                albumSource: source,
                source,
            }, albumMeta);

            const baseAlbumMeta = {
                id: mergedAlbum.albumId || mergedAlbum.id,
                name: mergedAlbum.name,
                artist: mergedAlbum.artist,
                pic_id: mergedAlbum.pic_id,
                source,
            };

            const tracks = Array.isArray(tracksRaw)
                ? tracksRaw.map(track => normalizeTrackData(track, baseAlbumMeta)).filter(Boolean)
                : [];

            if (!mergedAlbum.songCount) {
                mergedAlbum.songCount = tracks.length;
            }

            if (!mergedAlbum.publishYear && mergedAlbum.publishTime) {
                mergedAlbum.publishYear = extractAlbumYear(mergedAlbum.publishTime);
            }

            return {
                album: mergedAlbum,
                tracks,
            };
        },

        getSongUrl: (song, quality = "320") => {
            const signature = API.generateSignature();
            return `${API.baseUrl}?types=url&id=${song.id}&source=${song.source || "netease"}&br=${quality}&s=${signature}`;
        },

        getLyric: (song) => {
            const signature = API.generateSignature();
            return `${API.baseUrl}?types=lyric&id=${song.lyric_id || song.id}&source=${song.source || "netease"}&s=${signature}`;
        },

        getPicUrl: (song) => {
            const signature = API.generateSignature();
            return `${API.baseUrl}?types=pic&id=${song.pic_id}&source=${song.source || "netease"}&size=300&s=${signature}`;
        }
    };

    const state = {
        onlineSongs: [],
        searchResults: [],
        currentTrackIndex: savedCurrentTrackIndex,
        currentAudioUrl: null,
        lyricsData: [],
        currentLyricLine: -1,
        currentPlaylist: savedCurrentPlaylist, // 'online', 'search', or 'playlist'
        searchPage: 1,
        searchKeyword: "", // 确保这里有初始值
        searchSource: savedSearchSource,
        hasMoreResults: true,
        currentSong: savedCurrentSong,
        debugMode: false,
        isSearchMode: false, // 新增：搜索模式状态
        playlistSongs: savedPlaylistSongs, // 新增：统一播放列表
        playMode: savedPlayMode, // 新增：播放模式 'list', 'single', 'random'
        playbackQuality: savedPlaybackQuality,
        volume: savedVolume,
        currentPlaybackTime: savedPlaybackTime,
        lastSavedPlaybackTime: savedPlaybackTime,
        pendingSeekTime: null,
        isSeeking: false,
        qualityMenuOpen: false,
        sourceMenuOpen: false,
        userScrolledLyrics: false, // 新增：用户是否手动滚动歌词
        lyricsScrollTimeout: null, // 新增：歌词滚动超时
        activeAlbum: null,
        activeAlbumTracks: [],
        albumOverlayVisible: false,
        albumLoading: false,
    };

    function savePlayerState() {
        safeSetLocalStorage("playlistSongs", JSON.stringify(state.playlistSongs));
        safeSetLocalStorage("currentTrackIndex", String(state.currentTrackIndex));
        safeSetLocalStorage("playMode", state.playMode);
        safeSetLocalStorage("playbackQuality", state.playbackQuality);
        safeSetLocalStorage("playerVolume", String(state.volume));
        safeSetLocalStorage("currentPlaylist", state.currentPlaylist);
        if (state.currentSong) {
            safeSetLocalStorage("currentSong", JSON.stringify(state.currentSong));
        } else {
            safeSetLocalStorage("currentSong", "");
        }
        safeSetLocalStorage("currentPlaybackTime", String(state.currentPlaybackTime || 0));
    }

    // 调试日志函数
    function debugLog(message) {
        console.log(`[DEBUG] ${message}`);
        if (state.debugMode) {
            const debugInfo = dom.debugInfo;
            debugInfo.innerHTML += `<div>${new Date().toLocaleTimeString()}: ${message}</div>`;
            debugInfo.classList.add("show");
            debugInfo.scrollTop = debugInfo.scrollHeight;
        }
    }

    // 启用调试模式（按Ctrl+D）
    document.addEventListener("keydown", (e) => {
        if (e.ctrlKey && e.key === "d") {
            e.preventDefault();
            state.debugMode = !state.debugMode;
            if (state.debugMode) {
                dom.debugInfo.classList.add("show");
                debugLog("调试模式已启用");
            } else {
                dom.debugInfo.classList.remove("show");
            }
        }
    });

    // 新增：切换搜索模式
    function toggleSearchMode(enable) {
        state.isSearchMode = enable;
        if (enable) {
            dom.container.classList.add("search-mode");
            debugLog("进入搜索模式");
        } else {
            dom.container.classList.remove("search-mode");
            debugLog("退出搜索模式");
        }
    }

    // 新增：显示搜索结果
    function showSearchResults() {
        toggleSearchMode(true);
        if (state.sourceMenuOpen) {
            requestAnimationFrame(updateSourceMenuPosition);
        }
        if (state.qualityMenuOpen) {
            requestAnimationFrame(updatePlayerQualityMenuPosition);
        }
    }

    // 新增：隐藏搜索结果 - 优化立即收起
    function hideSearchResults() {
        toggleSearchMode(false);
        if (state.sourceMenuOpen) {
            requestAnimationFrame(updateSourceMenuPosition);
        }
        if (state.qualityMenuOpen) {
            requestAnimationFrame(updatePlayerQualityMenuPosition);
        }
        // 立即清空搜索结果内容
        dom.searchResults.innerHTML = "";
        if (state.albumOverlayVisible) {
            closeAlbumOverlay();
        }
    }

    const playModeTexts = {
        "list": "列表循环",
        "single": "单曲循环",
        "random": "随机播放"
    };

    const playModeIcons = {
        "list": "fa-repeat",
        "single": "fa-redo",
        "random": "fa-shuffle"
    };

    function updatePlayModeUI() {
        const mode = state.playMode;
        dom.playModeBtn.innerHTML = `<i class="fas ${playModeIcons[mode] || playModeIcons.list}"></i>`;
        dom.playModeBtn.title = `播放模式: ${playModeTexts[mode] || playModeTexts.list}`;
    }

    // 新增：播放模式切换
    function togglePlayMode() {
        const modes = ["list", "single", "random"];
        const currentIndex = modes.indexOf(state.playMode);
        const nextIndex = (currentIndex + 1) % modes.length;
        state.playMode = modes[nextIndex];

        updatePlayModeUI();
        savePlayerState();

        const modeText = playModeTexts[state.playMode] || playModeTexts.list;
        showNotification(`播放模式: ${modeText}`);
        debugLog(`播放模式切换为: ${state.playMode}`);
    }

    function formatTime(seconds) {
        if (!Number.isFinite(seconds) || seconds < 0) {
            return "00:00";
        }
        const totalSeconds = Math.floor(seconds);
        const minutes = Math.floor(totalSeconds / 60);
        const secs = totalSeconds % 60;
        return `${String(minutes).padStart(2, "0")}:${String(secs).padStart(2, "0")}`;
    }

    function updatePlayPauseButton() {
        if (!dom.playPauseBtn) return;
        const isPlaying = !dom.audioPlayer.paused && !dom.audioPlayer.ended;
        dom.playPauseBtn.innerHTML = `<i class="fas ${isPlaying ? "fa-pause" : "fa-play"}"></i>`;
        dom.playPauseBtn.title = isPlaying ? "暂停" : "播放";
    }

    function updateProgressBarBackground(value = Number(dom.progressBar.value), max = Number(dom.progressBar.max)) {
        const duration = Number.isFinite(max) && max > 0 ? max : 0;
        const progressValue = Number.isFinite(value) ? Math.max(value, 0) : 0;
        const percent = duration > 0 ? Math.min(progressValue / duration, 1) * 100 : 0;
        dom.progressBar.style.setProperty("--progress", `${percent}%`);
    }

    function updateVolumeSliderBackground(volume = dom.audioPlayer.volume) {
        const clamped = Math.min(Math.max(Number.isFinite(volume) ? volume : 0, 0), 1);
        dom.volumeSlider.style.setProperty("--volume-progress", `${clamped * 100}%`);
    }

    function updateVolumeIcon(volume) {
        if (!dom.volumeIcon) return;
        const clamped = Math.min(Math.max(Number.isFinite(volume) ? volume : 0, 0), 1);
        let icon = "fa-volume-high";
        if (clamped === 0) {
            icon = "fa-volume-xmark";
        } else if (clamped < 0.4) {
            icon = "fa-volume-low";
        }
        dom.volumeIcon.className = `fas ${icon}`;
    }

    function onAudioVolumeChange() {
        const volume = dom.audioPlayer.volume;
        state.volume = volume;
        dom.volumeSlider.value = volume;
        updateVolumeSliderBackground(volume);
        updateVolumeIcon(volume);
        savePlayerState();
    }

    function handleVolumeChange(event) {
        const volume = Number.parseFloat(event.target.value);
        const clamped = Number.isFinite(volume) ? Math.min(Math.max(volume, 0), 1) : dom.audioPlayer.volume;
        dom.audioPlayer.volume = clamped;
        state.volume = clamped;
        updateVolumeSliderBackground(clamped);
        updateVolumeIcon(clamped);
        safeSetLocalStorage("playerVolume", String(clamped));
    }

    function handleTimeUpdate() {
        const currentTime = dom.audioPlayer.currentTime || 0;
        if (!state.isSeeking) {
            dom.progressBar.value = currentTime;
            dom.currentTimeDisplay.textContent = formatTime(currentTime);
            updateProgressBarBackground(currentTime, Number(dom.progressBar.max));
        }

        syncLyrics();

        state.currentPlaybackTime = currentTime;
        if (Math.abs(currentTime - state.lastSavedPlaybackTime) >= 2) {
            state.lastSavedPlaybackTime = currentTime;
            safeSetLocalStorage("currentPlaybackTime", currentTime.toFixed(1));
        }
    }

    function handleLoadedMetadata() {
        const duration = dom.audioPlayer.duration || 0;
        dom.progressBar.max = duration;
        dom.durationDisplay.textContent = formatTime(duration);
        updateProgressBarBackground(dom.audioPlayer.currentTime || 0, duration);

        if (state.pendingSeekTime != null) {
            setAudioCurrentTime(state.pendingSeekTime);
            state.pendingSeekTime = null;
        }
    }

    function setAudioCurrentTime(time) {
        if (!Number.isFinite(time)) return;
        const duration = dom.audioPlayer.duration || Number(dom.progressBar.max) || 0;
        const clamped = duration > 0 ? Math.min(Math.max(time, 0), duration) : Math.max(time, 0);
        try {
            dom.audioPlayer.currentTime = clamped;
        } catch (error) {
            console.warn("设置播放进度失败", error);
        }
        dom.progressBar.value = clamped;
        dom.currentTimeDisplay.textContent = formatTime(clamped);
        updateProgressBarBackground(clamped, duration);
        state.currentPlaybackTime = clamped;
    }

    function handleProgressInput() {
        state.isSeeking = true;
        const value = Number(dom.progressBar.value);
        dom.currentTimeDisplay.textContent = formatTime(value);
        updateProgressBarBackground(value, Number(dom.progressBar.max));
    }

    function handleProgressChange() {
        const value = Number(dom.progressBar.value);
        state.isSeeking = false;
        seekAudio(value);
    }

    function seekAudio(value) {
        if (!Number.isFinite(value)) return;
        setAudioCurrentTime(value);
        state.lastSavedPlaybackTime = state.currentPlaybackTime;
        safeSetLocalStorage("currentPlaybackTime", state.currentPlaybackTime.toFixed(1));
    }

    async function togglePlayPause() {
        if (!state.currentSong) {
            if (state.playlistSongs.length > 0) {
                const targetIndex = state.currentTrackIndex >= 0 && state.currentTrackIndex < state.playlistSongs.length
                    ? state.currentTrackIndex
                    : 0;
                await playPlaylistSong(targetIndex);
            } else {
                showNotification("播放列表为空，请先添加歌曲", "error");
            }
            return;
        }

        if (!dom.audioPlayer.src) {
            try {
                await playSong(state.currentSong, {
                    autoplay: true,
                    startTime: state.currentPlaybackTime,
                    preserveProgress: true,
                });
            } catch (error) {
                console.error("恢复播放失败:", error);
                showNotification("播放失败，请稍后重试", "error");
            }
            return;
        }

        if (dom.audioPlayer.paused) {
            const playPromise = dom.audioPlayer.play();
            if (playPromise !== undefined) {
                playPromise.catch(error => {
                    console.error("播放失败:", error);
                    showNotification("播放失败，请检查网络连接", "error");
                });
            }
        } else {
            dom.audioPlayer.pause();
        }
    }

    function buildSourceMenu() {
        if (!dom.sourceMenu) return;
        const optionsHtml = SOURCE_OPTIONS.map(option => {
            const isActive = option.value === state.searchSource;
            return `
                <div class="source-option${isActive ? " active" : ""}" data-source="${option.value}" role="option" aria-selected="${isActive}">
                    <span>${option.label}</span>
                    ${isActive ? '<i class="fas fa-check" aria-hidden="true"></i>' : ""}
                </div>
            `;
        }).join("");
        dom.sourceMenu.innerHTML = optionsHtml;
        if (state.sourceMenuOpen) {
            requestAnimationFrame(updateSourceMenuPosition);
        }
    }

    function updateSourceLabel() {
        const option = SOURCE_OPTIONS.find(item => item.value === state.searchSource) || SOURCE_OPTIONS[0];
        if (!option || !dom.sourceSelectLabel || !dom.sourceSelectButton) return;
        dom.sourceSelectLabel.textContent = option.label;
        dom.sourceSelectButton.dataset.source = option.value;
        dom.sourceSelectButton.setAttribute("aria-expanded", state.sourceMenuOpen ? "true" : "false");
        dom.sourceSelectButton.setAttribute("aria-label", `当前音源：${option.label}，点击切换音源`);
        dom.sourceSelectButton.setAttribute("title", `音源：${option.label}`);
    }

    function updateSourceMenuPosition() {
        if (!state.sourceMenuOpen || !dom.sourceMenu || !dom.sourceSelectButton) return;

        const menu = dom.sourceMenu;
        const button = dom.sourceSelectButton;
        const spacing = 10;
        const buttonWidth = Math.ceil(button.getBoundingClientRect().width);
        const effectiveWidth = Math.max(buttonWidth, 140);

        menu.style.left = "0px";
        menu.style.width = `${effectiveWidth}px`;
        menu.style.minWidth = `${effectiveWidth}px`;
        menu.style.maxWidth = `${effectiveWidth}px`;

        const menuHeight = Math.max(menu.scrollHeight, 0);
        const buttonRect = button.getBoundingClientRect();
        const viewportHeight = Math.max(window.innerHeight || 0, document.documentElement.clientHeight || 0);
        const spaceBelow = Math.max(viewportHeight - buttonRect.bottom - spacing, 0);
        const canOpenUpwards = buttonRect.top - spacing - menuHeight >= 0;
        const shouldOpenUpwards = menuHeight > spaceBelow && canOpenUpwards;

        if (shouldOpenUpwards) {
            menu.classList.add("open-upwards");
            menu.classList.remove("open-downwards");
            menu.style.top = "";
            menu.style.bottom = `${button.offsetHeight + spacing}px`;
        } else {
            menu.classList.add("open-downwards");
            menu.classList.remove("open-upwards");
            menu.style.bottom = "";
            menu.style.top = `${button.offsetHeight + spacing}px`;
        }
    }

    function resetSourceMenuPosition() {
        if (!dom.sourceMenu) return;
        dom.sourceMenu.classList.remove("open-upwards", "open-downwards");
        dom.sourceMenu.style.top = "";
        dom.sourceMenu.style.left = "";
        dom.sourceMenu.style.bottom = "";
        dom.sourceMenu.style.minWidth = "";
        dom.sourceMenu.style.maxWidth = "";
        dom.sourceMenu.style.width = "";
    }

    function openSourceMenu() {
        if (!dom.sourceMenu || !dom.sourceSelectButton) return;
        state.sourceMenuOpen = true;
        buildSourceMenu();
        dom.sourceMenu.classList.add("show");
        dom.sourceSelectButton.classList.add("active");
        dom.sourceSelectButton.setAttribute("aria-expanded", "true");
        updateSourceMenuPosition();
        requestAnimationFrame(updateSourceMenuPosition);
    }

    function closeSourceMenu() {
        if (!dom.sourceMenu) return;
        dom.sourceMenu.classList.remove("show");
        dom.sourceSelectButton.classList.remove("active");
        dom.sourceSelectButton.setAttribute("aria-expanded", "false");
        state.sourceMenuOpen = false;
        resetSourceMenuPosition();
    }

    function toggleSourceMenu(event) {
        event.preventDefault();
        event.stopPropagation();
        if (state.sourceMenuOpen) {
            closeSourceMenu();
        } else {
            openSourceMenu();
        }
    }

    function handleSourceSelection(event) {
        const option = event.target.closest(".source-option");
        if (!option) return;
        event.preventDefault();
        event.stopPropagation();
        const { source } = option.dataset;
        if (source) {
            selectSearchSource(source);
        }
    }

    function selectSearchSource(source) {
        const normalized = normalizeSource(source);
        if (normalized === state.searchSource) {
            closeSourceMenu();
            return;
        }
        state.searchSource = normalized;
        safeSetLocalStorage("searchSource", normalized);
        updateSourceLabel();
        buildSourceMenu();
        closeSourceMenu();
    }

    function buildQualityMenu() {
        if (!dom.playerQualityMenu) return;
        const optionsHtml = QUALITY_OPTIONS.map(option => {
            const isActive = option.value === state.playbackQuality;
            return `
                <div class="player-quality-option${isActive ? " active" : ""}" data-quality="${option.value}">
                    <span>${option.label}</span>
                    <small>${option.description}</small>
                </div>
            `;
        }).join("");
        dom.playerQualityMenu.innerHTML = optionsHtml;
        if (state.qualityMenuOpen) {
            requestAnimationFrame(updatePlayerQualityMenuPosition);
        }
    }

    function updateQualityLabel() {
        const option = QUALITY_OPTIONS.find(item => item.value === state.playbackQuality) || QUALITY_OPTIONS[0];
        if (!option) return;
        dom.qualityLabel.textContent = option.label;
        dom.qualityToggle.title = `音质: ${option.label} (${option.description})`;
    }

    function togglePlayerQualityMenu(event) {
        event.preventDefault();
        event.stopPropagation();
        if (state.qualityMenuOpen) {
            closePlayerQualityMenu();
        } else {
            openPlayerQualityMenu();
        }
    }

    function updatePlayerQualityMenuPosition() {
        if (!state.qualityMenuOpen || !dom.playerQualityMenu || !dom.qualityToggle) return;

        const menu = dom.playerQualityMenu;
        const toggleRect = dom.qualityToggle.getBoundingClientRect();
        const viewportWidth = Math.max(window.innerWidth || 0, document.documentElement.clientWidth || 0);
        const viewportHeight = Math.max(window.innerHeight || 0, document.documentElement.clientHeight || 0);
        const spacing = 10;

        menu.classList.add("floating");

        const targetWidth = Math.max(Math.round(toggleRect.width), 180);
        menu.style.minWidth = `${targetWidth}px`;
        menu.style.maxWidth = `${targetWidth}px`;
        menu.style.width = `${targetWidth}px`;
        menu.style.right = "auto";

        const menuRect = menu.getBoundingClientRect();
        const menuHeight = Math.round(menuRect.height);
        const menuWidth = Math.round(menuRect.width) || targetWidth;

        let top = Math.round(toggleRect.bottom + spacing);
        let openUpwards = false;
        if (top + menuHeight > viewportHeight - spacing) {
            const upwardTop = Math.round(toggleRect.top - spacing - menuHeight);
            if (upwardTop >= spacing) {
                top = upwardTop;
                openUpwards = true;
            } else {
                top = Math.max(spacing, viewportHeight - spacing - menuHeight);
            }
        }

        let left = Math.round(toggleRect.right - menuWidth);
        const minLeft = spacing;
        const maxLeft = Math.max(minLeft, viewportWidth - spacing - menuWidth);
        left = Math.min(Math.max(left, minLeft), maxLeft);

        menu.style.top = `${top}px`;
        menu.style.left = `${left}px`;
        menu.classList.toggle("open-upwards", openUpwards);
        menu.classList.toggle("open-downwards", !openUpwards);
    }

    function resetPlayerQualityMenuPosition() {
        if (!dom.playerQualityMenu) return;
        dom.playerQualityMenu.classList.remove("floating", "open-upwards", "open-downwards");
        dom.playerQualityMenu.style.top = "";
        dom.playerQualityMenu.style.left = "";
        dom.playerQualityMenu.style.right = "";
        dom.playerQualityMenu.style.minWidth = "";
        dom.playerQualityMenu.style.maxWidth = "";
        dom.playerQualityMenu.style.width = "";
    }

    function openPlayerQualityMenu() {
        if (!dom.playerQualityMenu || !dom.qualityToggle) return;
        state.qualityMenuOpen = true;
        dom.playerQualityMenu.classList.add("floating");
        dom.playerQualityMenu.classList.add("show");
        dom.qualityToggle.classList.add("active");
        updatePlayerQualityMenuPosition();
        requestAnimationFrame(updatePlayerQualityMenuPosition);
    }

    function closePlayerQualityMenu() {
        if (!dom.playerQualityMenu) return;
        dom.playerQualityMenu.classList.remove("show");
        dom.qualityToggle.classList.remove("active");
        state.qualityMenuOpen = false;
        resetPlayerQualityMenuPosition();
    }

    function handlePlayerQualitySelection(event) {
        const option = event.target.closest(".player-quality-option");
        if (!option) return;
        event.preventDefault();
        event.stopPropagation();
        const { quality } = option.dataset;
        if (quality) {
            selectPlaybackQuality(quality);
        }
    }

    async function selectPlaybackQuality(quality) {
        const normalized = normalizeQuality(quality);
        if (normalized === state.playbackQuality) {
            closePlayerQualityMenu();
            return;
        }

        state.playbackQuality = normalized;
        updateQualityLabel();
        buildQualityMenu();
        savePlayerState();
        closePlayerQualityMenu();

        const option = QUALITY_OPTIONS.find(item => item.value === normalized);
        if (option) {
            showNotification(`音质已切换为 ${option.label} (${option.description})`);
        }

        if (state.currentSong) {
            const success = await reloadCurrentSong();
            if (!success) {
                showNotification("切换音质失败，请稍后重试", "error");
            }
        }
    }

    async function reloadCurrentSong() {
        if (!state.currentSong) return true;
        const wasPlaying = !dom.audioPlayer.paused;
        const targetTime = dom.audioPlayer.currentTime || state.currentPlaybackTime || 0;
        try {
            await playSong(state.currentSong, {
                autoplay: wasPlaying,
                startTime: targetTime,
                preserveProgress: true,
            });
            if (!wasPlaying) {
                dom.audioPlayer.pause();
                updatePlayPauseButton();
            }
            return true;
        } catch (error) {
            console.error("切换音质失败:", error);
            return false;
        }
    }

    async function restoreCurrentSongState() {
        if (!state.currentSong) return;
        try {
            await playSong(state.currentSong, {
                autoplay: false,
                startTime: state.currentPlaybackTime,
                preserveProgress: true,
            });
            dom.audioPlayer.pause();
            updatePlayPauseButton();
        } catch (error) {
            console.warn("恢复音频失败:", error);
        }
    }

    window.addEventListener("load", setupInteractions);
    dom.audioPlayer.addEventListener("ended", autoPlayNext);

    function setupInteractions() {
        function applyTheme(isDark) {
            document.body.classList.toggle("dark-mode", isDark);
            dom.themeToggleButton.classList.toggle("is-dark", isDark);
            const label = isDark ? "切换为浅色模式" : "切换为深色模式";
            dom.themeToggleButton.setAttribute("aria-label", label);
            dom.themeToggleButton.setAttribute("title", label);
        }

        const savedTheme = safeGetLocalStorage("theme");
        const prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
        const initialIsDark = savedTheme ? savedTheme === "dark" : prefersDark;
        applyTheme(initialIsDark);

        dom.themeToggleButton.addEventListener("click", () => {
            const isDark = !document.body.classList.contains("dark-mode");
            applyTheme(isDark);
            safeSetLocalStorage("theme", isDark ? "dark" : "light");
        });

        dom.audioPlayer.volume = state.volume;
        dom.volumeSlider.value = state.volume;
        updateVolumeSliderBackground(state.volume);
        updateVolumeIcon(state.volume);

        buildSourceMenu();
        updateSourceLabel();
        buildQualityMenu();
        updateQualityLabel();
        updatePlayPauseButton();
        dom.currentTimeDisplay.textContent = formatTime(state.currentPlaybackTime);
        updateProgressBarBackground(0, Number(dom.progressBar.max));

        dom.playPauseBtn.addEventListener("click", togglePlayPause);
        dom.audioPlayer.addEventListener("timeupdate", handleTimeUpdate);
        dom.audioPlayer.addEventListener("loadedmetadata", handleLoadedMetadata);
        dom.audioPlayer.addEventListener("play", updatePlayPauseButton);
        dom.audioPlayer.addEventListener("pause", updatePlayPauseButton);
        dom.audioPlayer.addEventListener("volumechange", onAudioVolumeChange);

        dom.progressBar.addEventListener("input", handleProgressInput);
        dom.progressBar.addEventListener("change", handleProgressChange);
        dom.progressBar.addEventListener("pointerup", handleProgressChange);

        dom.volumeSlider.addEventListener("input", handleVolumeChange);

        if (dom.sourceSelectButton && dom.sourceMenu) {
            dom.sourceSelectButton.addEventListener("click", toggleSourceMenu);
            dom.sourceMenu.addEventListener("click", handleSourceSelection);
        }
        window.addEventListener("resize", () => {
            updateSourceMenuPosition();
            updatePlayerQualityMenuPosition();
        });
        window.addEventListener("scroll", () => {
            updateSourceMenuPosition();
            updatePlayerQualityMenuPosition();
        }, true);
        dom.qualityToggle.addEventListener("click", togglePlayerQualityMenu);
        dom.playerQualityMenu.addEventListener("click", handlePlayerQualitySelection);

        if (dom.closeAlbumOverlayBtn) {
            dom.closeAlbumOverlayBtn.addEventListener("click", closeAlbumOverlay);
        }
        if (dom.playAlbumBtn) {
            dom.playAlbumBtn.addEventListener("click", playActiveAlbum);
        }
        if (dom.addAlbumBtn) {
            dom.addAlbumBtn.addEventListener("click", addActiveAlbumToPlaylist);
        }
        if (dom.albumOverlay) {
            dom.albumOverlay.addEventListener("click", (event) => {
                if (event.target === dom.albumOverlay) {
                    closeAlbumOverlay();
                }
            });
        }

        dom.loadOnlineBtn.addEventListener("click", exploreOnlineMusic);

        dom.showPlaylistBtn.addEventListener("click", () => switchMobileView("playlist"));
        dom.showLyricsBtn.addEventListener("click", () => switchMobileView("lyrics"));

        // 播放模式按钮事件
        updatePlayModeUI();
        dom.playModeBtn.addEventListener("click", togglePlayMode);
        
        // 搜索相关事件 - 修复搜索下拉框显示问题
        dom.searchBtn.addEventListener("click", (e) => {
            e.preventDefault();
            e.stopPropagation();
            debugLog("搜索按钮被点击");
            performSearch();
        });
        
        dom.searchInput.addEventListener("keypress", (e) => {
            if (e.key === "Enter") {
                e.preventDefault();
                e.stopPropagation();
                debugLog("搜索输入框回车键被按下");
                performSearch();
            }
        });
        
        // 修复：点击搜索区域外部时隐藏搜索结果
        document.addEventListener("click", (e) => {
            const searchArea = document.querySelector(".search-area");
            if (searchArea && !searchArea.contains(e.target) && state.isSearchMode && !state.albumOverlayVisible) {
                debugLog("点击搜索区域外部，隐藏搜索结果");
                hideSearchResults();
            }
        });

        document.addEventListener("keydown", (e) => {
            if (e.key === "Escape") {
                if (state.sourceMenuOpen) {
                    closeSourceMenu();
                }
                if (state.albumOverlayVisible) {
                    closeAlbumOverlay();
                }
            }
        });
        
        // 搜索结果相关事件处理 - 修复加载更多按钮点击问题
        document.addEventListener("click", (e) => {
            const qualityMenus = document.querySelectorAll(".quality-menu");
            qualityMenus.forEach(menu => {
                if (!menu.contains(e.target) &&
                    !e.target.closest(".playlist-item-download")) {
                    menu.classList.remove("show");
                    const parentItem = menu.closest(".search-result-item");
                    if (parentItem) parentItem.classList.remove("menu-active");
                }
            });

            if (state.qualityMenuOpen &&
                !dom.playerQualityMenu.contains(e.target) &&
                !dom.qualityToggle.contains(e.target)) {
                closePlayerQualityMenu();
            }

            if (state.sourceMenuOpen &&
                dom.sourceMenu &&
                dom.sourceSelectButton &&
                !dom.sourceMenu.contains(e.target) &&
                !dom.sourceSelectButton.contains(e.target)) {
                closeSourceMenu();
            }
        });
        
        // 修复：使用更强健的事件委托处理加载更多按钮点击
        dom.searchResults.addEventListener("click", (e) => {
            debugLog(`点击事件触发: ${e.target.tagName} ${e.target.className} ${e.target.id}`);
            
            // 检查多种可能的目标元素
            const loadMoreBtn = e.target.closest(".load-more-btn") || 
                               e.target.closest("#loadMoreBtn") ||
                               (e.target.id === "loadMoreBtn" ? e.target : null) ||
                               (e.target.classList.contains("load-more-btn") ? e.target : null);
            
            if (loadMoreBtn) {
                debugLog("检测到加载更多按钮点击");
                e.preventDefault();
                e.stopPropagation();
                loadMoreResults();
            }
        });
        
        // 额外的直接事件监听器作为备用
        document.addEventListener("click", (e) => {
            if (e.target.id === "loadMoreBtn" || e.target.closest("#loadMoreBtn")) {
                debugLog("备用事件监听器触发");
                e.preventDefault();
                e.stopPropagation();
                loadMoreResults();
            }
        });

        // 新增：歌词滚动监听
        dom.lyrics.addEventListener("scroll", () => {
            state.userScrolledLyrics = true;
            clearTimeout(state.lyricsScrollTimeout);
            // 3秒后恢复自动滚动并回位到当前歌词
            state.lyricsScrollTimeout = setTimeout(() => {
                state.userScrolledLyrics = false;
                // 立即滚动回当前歌词居中位置
                const currentLyricElement = dom.lyrics.querySelector(".current");
                if (currentLyricElement) {
                    scrollToCurrentLyric(currentLyricElement);
                }
            }, 3000);
        });

        if (state.playlistSongs.length > 0) {
            let restoredIndex = state.currentTrackIndex;
            if (restoredIndex < 0 || restoredIndex >= state.playlistSongs.length) {
                restoredIndex = 0;
            }

            state.currentTrackIndex = restoredIndex;
            state.currentPlaylist = "playlist";
            renderPlaylist();

            const restoredSong = state.playlistSongs[restoredIndex];
            if (restoredSong) {
                state.currentSong = restoredSong;
                updatePlaylistHighlight();
                updateCurrentSongInfo(restoredSong).catch(error => {
                    console.error("恢复歌曲信息失败:", error);
                });
            }

            savePlayerState();
        } else {
            dom.playlist.classList.add("empty");
            if (dom.playlistItems) {
                dom.playlistItems.innerHTML = "";
            }
        }

        if (state.currentSong) {
            restoreCurrentSongState();
        }
    }

    // 修复：更新当前歌曲信息和封面
    async function updateCurrentSongInfo(song) {
        state.currentSong = song;
        dom.currentSongTitle.textContent = song.name;
        
        // 修复艺人名称显示问题 - 使用正确的字段名
        const artistText = Array.isArray(song.artist) ? song.artist.join(', ') : (song.artist || '未知艺术家');
        dom.currentSongArtist.textContent = artistText;
        
        // 加载封面
        if (song.pic_id) {
            try {
                dom.albumCover.classList.add("loading");
                const picUrl = API.getPicUrl(song);
                
                // 修复：直接使用JSONP请求获取封面数据
                const data = await API.fetchJson(picUrl);
                
                if (data && data.url) {
                    // 预加载图片以确保加载成功
                    const img = new Image();
                    img.onload = () => {
                        dom.albumCover.innerHTML = `<img src="${data.url}" alt="专辑封面">`;
                        dom.albumCover.classList.remove("loading");
                    };
                    img.onerror = () => {
                        dom.albumCover.innerHTML = "<div class=\"placeholder\"><i class=\"fas fa-music\"></i></div>";
                        dom.albumCover.classList.remove("loading");
                    };
                    img.src = data.url;
                } else {
                    dom.albumCover.innerHTML = "<div class=\"placeholder\"><i class=\"fas fa-music\"></i></div>";
                    dom.albumCover.classList.remove("loading");
                }
            } catch (error) {
                console.error("加载封面失败:", error);
                dom.albumCover.innerHTML = "<div class=\"placeholder\"><i class=\"fas fa-music\"></i></div>";
                dom.albumCover.classList.remove("loading");
            }
        } else {
            dom.albumCover.innerHTML = "<div class=\"placeholder\"><i class=\"fas fa-music\"></i></div>";
            dom.albumCover.classList.remove("loading");
        }
    }
    
    // 搜索功能 - 修复搜索下拉框显示问题
    async function performSearch(isLiveSearch = false) {
        const query = dom.searchInput.value.trim();
        if (!query) {
            showNotification("请输入搜索关键词", "error");
            return;
        }

        if (state.sourceMenuOpen) {
            closeSourceMenu();
        }

        const source = normalizeSource(state.searchSource);
        state.searchSource = source;
        safeSetLocalStorage("searchSource", source);
        updateSourceLabel();
        buildSourceMenu();
        
        // 重置搜索状态
        if (!isLiveSearch) {
            state.searchPage = 1;
            state.searchKeyword = query;
            state.searchSource = source;
            state.searchResults = [];
            state.hasMoreResults = true;
            debugLog(`开始新搜索: ${query}, 来源: ${source}`);
        } else {
            state.searchKeyword = query;
            state.searchSource = source;
        }

        try {
            // 禁用搜索按钮并显示加载状态
            dom.searchBtn.disabled = true;
            dom.searchBtn.innerHTML = '<span class="loader"></span><span>搜索中...</span>';
            
            // 立即显示搜索模式
            showSearchResults();
            debugLog("已切换到搜索模式");
            
            // 执行搜索
            const results = await API.search(query, source, 20, state.searchPage);
            debugLog(`API返回结果数量: ${results.length}`);
            
            if (state.searchPage === 1) {
                state.searchResults = results;
            } else {
                state.searchResults = [...state.searchResults, ...results];
            }
            
            state.hasMoreResults = results.length === 20;

            // 显示搜索结果
            renderSearchResults(state.searchResults);
            debugLog(`搜索完成: 总共显示 ${state.searchResults.length} 个结果`);
            
            // 如果没有结果，显示提示
            if (state.searchResults.length === 0) {
                showNotification("未找到相关歌曲", "error");
            }
            
        } catch (error) {
            console.error("搜索失败:", error);
            showNotification("搜索失败，请稍后重试", "error");
            hideSearchResults();
            debugLog(`搜索失败: ${error.message}`);
        } finally {
            // 恢复搜索按钮状态
            dom.searchBtn.disabled = false;
            dom.searchBtn.innerHTML = '<i class="fas fa-search"></i><span>搜索</span>';
        }
    }

    // 加载更多搜索结果
    async function loadMoreResults() {
        if (!state.hasMoreResults || !state.searchKeyword) {
            debugLog("没有更多结果或搜索关键词为空");
            return;
        }
        
        const loadMoreBtn = document.getElementById("loadMoreBtn");
        if (!loadMoreBtn) {
            debugLog("找不到加载更多按钮");
            return;
        }
        
        try {
            loadMoreBtn.disabled = true;
            loadMoreBtn.innerHTML = '<span class="loader"></span><span>加载中...</span>';
            
            state.searchPage++;
            debugLog(`加载第 ${state.searchPage} 页结果`);
            
            const source = normalizeSource(state.searchSource);
            state.searchSource = source;
            safeSetLocalStorage("searchSource", source);
            const results = await API.search(state.searchKeyword, source, 20, state.searchPage);
            
            if (results.length > 0) {
                state.searchResults = [...state.searchResults, ...results];
                state.hasMoreResults = results.length === 20;
                renderSearchResults(state.searchResults);
                debugLog(`加载完成: 新增 ${results.length} 个结果`);
            } else {
                state.hasMoreResults = false;
                showNotification("没有更多结果了");
                debugLog("没有更多结果");
            }
        } catch (error) {
            console.error("加载更多失败:", error);
            showNotification("加载失败，请稍后重试", "error");
            state.searchPage--; // 回退页码
        } finally {
            if (loadMoreBtn) {
                loadMoreBtn.disabled = false;
                loadMoreBtn.innerHTML = "<i class=\"fas fa-plus\"></i><span>加载更多</span>";
            }
        }
    }
    
    function renderSearchResults(results) {
        dom.playlist.classList.remove("empty");
        if (results.length === 0) {
            dom.searchResults.innerHTML = "<div style=\"text-align: center; color: var(--text-secondary-color); padding: 20px;\">未找到相关歌曲</div>";
            return;
        }
        
        const resultsHtml = results.map((item, index) => {
            const artistText = Array.isArray(item.artist) ? item.artist.join(', ') : (item.artist || '未知艺术家');

            if (item.type === "album") {
                const coverUrl = item.coverUrl ? preferHttpsUrl(item.coverUrl) : null;
                const songCount = item.songCount || (Array.isArray(item.tracks) ? item.tracks.length : 0);
                const metaParts = [];
                if (item.publishYear) metaParts.push(item.publishYear);
                if (songCount) metaParts.push(`${songCount} 首曲目`);
                const metaText = metaParts.join(' · ');

                return `
                    <div class="search-result-item album" data-index="${index}" data-type="album">
                        <div class="album-thumb">
                            ${coverUrl ? `<img src="${coverUrl}" alt="${item.name} 专辑封面">` : '<i class="fas fa-compact-disc"></i>'}
                        </div>
                        <div class="search-result-info">
                            <div class="search-result-title"><i class="fas fa-compact-disc"></i> ${item.name}</div>
                            <div class="search-result-artist">${artistText}</div>
                            <div class="search-result-meta">${metaText || '专辑详情'}</div>
                        </div>
                        <div class="album-result-actions">
                            <button class="action-btn play" onclick="openAlbumResult(${index})" title="查看专辑">
                                <i class="fas fa-eye"></i> 查看专辑
                            </button>
                            <button class="action-btn secondary" onclick="addAlbumPreviewToPlaylist(${index})" title="添加到播放列表">
                                <i class="fas fa-plus"></i> 快速添加
                            </button>
                        </div>
                    </div>
                `;
            }

            const albumSuffix = item.album ? ` - ${item.album}` : "";
            return `
                <div class="search-result-item" data-index="${index}" data-type="song">
                    <div class="search-result-info">
                        <div class="search-result-title">${item.name}</div>
                        <div class="search-result-artist">${artistText}${albumSuffix}</div>
                    </div>
                    <div class="search-result-actions">
                        <button class="action-btn play" onclick="playSearchResult(${index})" title="播放">
                            <i class="fas fa-play"></i> 播放
                        </button>
                        <button class="action-btn download" onclick="showQualityMenu(event, ${index}, 'search')" title="下载">
                            <i class="fas fa-download"></i>
                            <div class="quality-menu">
                                <div class="quality-option" onclick="downloadWithQuality(event, ${index}, 'search', '128')">标准音质 (128k)</div>
                                <div class="quality-option" onclick="downloadWithQuality(event, ${index}, 'search', '192')">高音质 (192k)</div>
                                <div class="quality-option" onclick="downloadWithQuality(event, ${index}, 'search', '320')">超高音质 (320k)</div>
                                <div class="quality-option" onclick="downloadWithQuality(event, ${index}, 'search', '999')">无损音质</div>
                            </div>
                        </button>
                    </div>
                </div>
            `;
        }).join("");

        // 修复：改进加载更多按钮的生成和绑定
        const loadMoreHtml = state.hasMoreResults ? `
            <button id="loadMoreBtn" class="load-more-btn" onclick="loadMoreResults()">
                <i class="fas fa-plus"></i>
                <span>加载更多</span>
            </button>
        ` : "";
        
        dom.searchResults.innerHTML = resultsHtml + loadMoreHtml;

        debugLog(`显示搜索结果: ${results.length} 个结果, 加载更多按钮: ${state.hasMoreResults ? "显示" : "隐藏"}`);
    }

    function showAlbumOverlay() {
        if (!dom.albumOverlay) return;
        dom.albumOverlay.classList.add("show");
        dom.albumOverlay.setAttribute("aria-hidden", "false");
        state.albumOverlayVisible = true;
    }

    function resetAlbumOverlayContent() {
        if (dom.albumHeroCover) {
            dom.albumHeroCover.innerHTML = `<div class="placeholder"><i class="fas fa-compact-disc"></i></div>`;
            dom.albumHeroCover.classList.remove("loading");
        }
        if (dom.albumHeroTitle) {
            dom.albumHeroTitle.textContent = "精选专辑";
        }
        if (dom.albumHeroArtist) {
            dom.albumHeroArtist.textContent = "未知艺人";
        }
        if (dom.albumHeroMeta) {
            dom.albumHeroMeta.textContent = "";
        }
        if (dom.albumTrackList) {
            dom.albumTrackList.innerHTML = `<div class="album-empty-placeholder">从搜索结果中选择一张专辑，体验沉浸式播放。</div>`;
        }
        if (dom.albumOverlay) {
            dom.albumOverlay.style.removeProperty("--album-backdrop-image");
        }
    }

    function closeAlbumOverlay() {
        if (!dom.albumOverlay) return;
        dom.albumOverlay.classList.remove("show");
        dom.albumOverlay.setAttribute("aria-hidden", "true");
        state.albumOverlayVisible = false;
        state.albumLoading = false;
        state.activeAlbum = null;
        state.activeAlbumTracks = [];
        resetAlbumOverlayContent();
    }

    async function loadAlbumHeroCover(album) {
        if (!dom.albumHeroCover) return;
        const coverContainer = dom.albumHeroCover;
        coverContainer.classList.add("loading");

        let imageUrl = album.coverUrl ? preferHttpsUrl(album.coverUrl) : null;

        if (!imageUrl && album.pic_id) {
            try {
                const picData = await API.fetchJson(API.getPicUrl(album));
                if (picData && picData.url) {
                    imageUrl = preferHttpsUrl(picData.url);
                    album.coverUrl = imageUrl;
                }
            } catch (error) {
                console.warn("获取专辑封面失败:", error);
            }
        }

        coverContainer.classList.remove("loading");

        if (imageUrl) {
            coverContainer.innerHTML = `<img src="${imageUrl}" alt="${album.name || '专辑封面'}">`;
            if (dom.albumOverlay) {
                dom.albumOverlay.style.setProperty("--album-backdrop-image", `url('${imageUrl}')`);
            }
        } else {
            coverContainer.innerHTML = `<div class="placeholder"><i class="fas fa-compact-disc"></i></div>`;
            if (dom.albumOverlay) {
                dom.albumOverlay.style.removeProperty("--album-backdrop-image");
            }
        }
    }

    async function updateAlbumHero(album, tracks = []) {
        if (!album) return;
        if (dom.albumHeroTitle) {
            dom.albumHeroTitle.textContent = album.name || "精选专辑";
        }
        if (dom.albumHeroArtist) {
            const artistText = Array.isArray(album.artist) ? album.artist.join(', ') : (album.artist || '未知艺人');
            dom.albumHeroArtist.textContent = artistText;
        }
        if (dom.albumHeroMeta) {
            const metaParts = [];
            const trackCount = album.songCount || tracks.length;
            if (album.publishYear) metaParts.push(album.publishYear);
            if (trackCount) metaParts.push(`${trackCount} 首曲目`);
            const source = album.albumSource || album.source;
            if (source) metaParts.push(source.toUpperCase());
            dom.albumHeroMeta.textContent = metaParts.join(' · ');
        }
        await loadAlbumHeroCover(album);
    }

    function renderAlbumTrackList(tracks = []) {
        if (!dom.albumTrackList) return;
        if (state.albumLoading) {
            dom.albumTrackList.innerHTML = `<div class="album-track-loading"><span class="loader"></span><span>正在拉取专辑曲目...</span></div>`;
            return;
        }

        if (!tracks || tracks.length === 0) {
            dom.albumTrackList.innerHTML = `<div class="album-empty-placeholder">暂时无法获取专辑曲目</div>`;
            return;
        }

        const rowsHtml = tracks.map((track, index) => {
            const inPlaylist = state.playlistSongs.some(song => song.id === track.id && song.source === track.source);
            const artistText = Array.isArray(track.artist) ? track.artist.join(', ') : (track.artist || '未知艺术家');
            return `
                <div class="album-track-row${inPlaylist ? ' in-playlist' : ''}" data-index="${index}">
                    <div class="album-track-index">${index + 1}</div>
                    <div class="album-track-info">
                        <div class="album-track-title">${track.name}</div>
                        <div class="album-track-artist">${artistText}</div>
                    </div>
                    <div class="album-track-actions">
                        <button class="action-btn play" onclick="playAlbumTrack(${index})" title="播放这首歌">
                            <i class="fas fa-play"></i>
                        </button>
                        <button class="action-btn" onclick="addAlbumTrackToPlaylist(${index})" title="添加到播放列表">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
            `;
        }).join("");

        dom.albumTrackList.innerHTML = rowsHtml;
    }

    async function openAlbumResult(index) {
        const album = state.searchResults[index];
        if (!album || album.type !== "album") return;

        state.activeAlbum = cloneSongData(album);
        state.activeAlbumTracks = dedupeTracks(album.tracks || []);
        state.albumLoading = state.activeAlbumTracks.length === 0;

        showAlbumOverlay();
        await updateAlbumHero(state.activeAlbum, state.activeAlbumTracks);
        renderAlbumTrackList(state.activeAlbumTracks);

        if (!state.albumLoading) {
            return;
        }

        try {
            const detail = await API.getAlbumDetail(album);
            const mergedAlbum = mergeAlbumMetadata({ ...state.activeAlbum }, detail.album || {});
            mergedAlbum.type = "album";
            mergedAlbum.albumId = mergedAlbum.albumId || mergedAlbum.id;
            const tracks = dedupeTracks(detail.tracks || []);
            mergedAlbum.tracks = tracks;
            mergedAlbum.songCount = mergedAlbum.songCount || tracks.length;

            state.activeAlbum = mergedAlbum;
            state.activeAlbumTracks = tracks;
            state.albumLoading = false;

            state.searchResults[index] = mergedAlbum;
            renderSearchResults(state.searchResults);

            await updateAlbumHero(state.activeAlbum, state.activeAlbumTracks);
            renderAlbumTrackList(state.activeAlbumTracks);
        } catch (error) {
            console.error("加载专辑详情失败:", error);
            state.albumLoading = false;
            renderAlbumTrackList(state.activeAlbumTracks);
            showNotification("专辑详情加载失败，请稍后重试", "error");
        }
    }

    async function addAlbumPreviewToPlaylist(index) {
        const album = state.searchResults[index];
        if (!album || album.type !== "album") return;

        try {
            let tracks = Array.isArray(album.tracks) && album.tracks.length > 0 ? album.tracks : null;
            if (!tracks) {
                const detail = await API.getAlbumDetail(album);
                const mergedAlbum = mergeAlbumMetadata({ ...album }, detail.album || {});
                mergedAlbum.type = "album";
                mergedAlbum.albumId = mergedAlbum.albumId || mergedAlbum.id;
                mergedAlbum.tracks = dedupeTracks(detail.tracks || []);
                mergedAlbum.songCount = mergedAlbum.songCount || mergedAlbum.tracks.length;
                state.searchResults[index] = mergedAlbum;
                tracks = mergedAlbum.tracks;
                renderSearchResults(state.searchResults);

                if (state.activeAlbum && state.activeAlbum.id === mergedAlbum.id) {
                    state.activeAlbum = mergedAlbum;
                    state.activeAlbumTracks = mergedAlbum.tracks;
                    renderAlbumTrackList(state.activeAlbumTracks);
                }
            }

            if (!tracks || tracks.length === 0) {
                showNotification("该专辑暂无可播放曲目", "warning");
                return;
            }

            let added = 0;
            tracks.forEach(track => {
                if (!track) return;
                const exists = state.playlistSongs.some(song => song.id === track.id && song.source === track.source);
                if (exists) return;
                state.playlistSongs.push(cloneSongData(track));
                added++;
            });

            if (added > 0) {
                renderPlaylist();
                renderAlbumTrackList(state.activeAlbumTracks);
                showNotification(`已添加专辑《${album.name}》的 ${added} 首曲目`, "success");
            } else {
                showNotification("专辑曲目已存在于播放列表", "warning");
            }
        } catch (error) {
            console.error("添加专辑到播放列表失败:", error);
            showNotification("添加失败，请稍后重试", "error");
        }
    }

    async function playActiveAlbum() {
        if (!state.activeAlbum) {
            showNotification("请先选择一个专辑", "warning");
            return;
        }
        if (state.albumLoading) {
            showNotification("专辑曲目仍在加载中", "warning");
            return;
        }
        if (!state.activeAlbumTracks || state.activeAlbumTracks.length === 0) {
            showNotification("该专辑暂无可播放曲目", "warning");
            return;
        }

        const tracks = dedupeTracks(state.activeAlbumTracks);
        if (tracks.length === 0) {
            showNotification("没有可播放的曲目", "warning");
            return;
        }

        state.playlistSongs = tracks.map(track => cloneSongData(track));
        state.currentTrackIndex = 0;
        state.currentPlaylist = "playlist";
        renderPlaylist();

        const albumName = state.activeAlbum.name || "专辑";
        closeAlbumOverlay();
        await playPlaylistSong(0);
        showNotification(`正在播放专辑《${albumName}》`, "success");
    }

    function addActiveAlbumToPlaylist() {
        if (!state.activeAlbum) {
            showNotification("请先打开一个专辑", "warning");
            return;
        }
        if (state.albumLoading) {
            showNotification("专辑曲目仍在加载中", "warning");
            return;
        }
        if (!state.activeAlbumTracks || state.activeAlbumTracks.length === 0) {
            showNotification("没有可添加的曲目", "warning");
            return;
        }

        let added = 0;
        state.activeAlbumTracks.forEach(track => {
            if (!track) return;
            const exists = state.playlistSongs.some(song => song.id === track.id && song.source === track.source);
            if (exists) return;
            state.playlistSongs.push(cloneSongData(track));
            added++;
        });

        if (added > 0) {
            renderPlaylist();
            renderAlbumTrackList(state.activeAlbumTracks);
            showNotification(`已将 ${added} 首曲目加入播放列表`, "success");
        } else {
            showNotification("这些曲目已经在播放列表中", "warning");
        }
    }

    async function playAlbumTrack(index) {
        if (state.albumLoading) return;
        const track = state.activeAlbumTracks[index];
        if (!track) return;

        let targetIndex = state.playlistSongs.findIndex(song => song.id === track.id && song.source === track.source);
        if (targetIndex === -1) {
            state.playlistSongs.push(cloneSongData(track));
            targetIndex = state.playlistSongs.length - 1;
            renderPlaylist();
        }

        const trackName = track.name;
        closeAlbumOverlay();
        await playPlaylistSong(targetIndex);
        showNotification(`正在播放: ${trackName}`);
    }

    function addAlbumTrackToPlaylist(index) {
        if (state.albumLoading) return;
        const track = state.activeAlbumTracks[index];
        if (!track) return;

        const exists = state.playlistSongs.some(song => song.id === track.id && song.source === track.source);
        if (exists) {
            showNotification("这首歌已在播放列表中", "warning");
            renderAlbumTrackList(state.activeAlbumTracks);
            return;
        }

        state.playlistSongs.push(cloneSongData(track));
        renderPlaylist();
        renderAlbumTrackList(state.activeAlbumTracks);
        showNotification(`已添加到播放列表: ${track.name}`, "success");
    }

    // 显示质量选择菜单
    function showQualityMenu(event, index, type) {
        event.stopPropagation();

        // 移除现有的质量菜单
        const existingMenu = document.querySelector(".dynamic-quality-menu");
        if (existingMenu) {
            existingMenu.remove();
        }
        
        // 创建新的质量菜单
        const menu = document.createElement("div");
        menu.className = "dynamic-quality-menu";
        menu.innerHTML = `
            <div class="quality-option" onclick="downloadWithQuality(event, ${index}, '${type}', '128')">标准音质 (128k)</div>
            <div class="quality-option" onclick="downloadWithQuality(event, ${index}, '${type}', '192')">高音质 (192k)</div>
            <div class="quality-option" onclick="downloadWithQuality(event, ${index}, '${type}', '320')">超高音质 (320k)</div>
            <div class="quality-option" onclick="downloadWithQuality(event, ${index}, '${type}', '999')">无损音质</div>
        `;
        
        // 设置菜单位置
        const button = event.target.closest("button");
        const rect = button.getBoundingClientRect();
        menu.style.position = "fixed";
        menu.style.top = (rect.bottom + 5) + "px";
        menu.style.left = (rect.left - 50) + "px";
        menu.style.zIndex = "10000";
        
        // 添加到body
        document.body.appendChild(menu);
        
        // 点击其他地方关闭菜单
        setTimeout(() => {
            document.addEventListener("click", function closeMenu(e) {
                if (!menu.contains(e.target)) {
                    menu.remove();
                    document.removeEventListener("click", closeMenu);
                }
            });
        }, 0);
    }

    // 根据质量下载 - 支持播放列表模式
    async function downloadWithQuality(event, index, type, quality) {
        event.stopPropagation();
        let song;
        
        if (type === "search") {
            song = state.searchResults[index];
        } else if (type === "online") {
            song = state.onlineSongs[index];
        } else if (type === "playlist") {
            song = state.playlistSongs[index];
        }
        
        if (!song) return;

        if (song.type === "album") {
            showNotification("请先打开专辑以选择具体曲目", "warning");
            return;
        }

        // 关闭菜单并移除 menu-active 类
        document.querySelectorAll(".quality-menu").forEach(menu => {
            menu.classList.remove("show");
            const parentItem = menu.closest(".search-result-item");
            if (parentItem) parentItem.classList.remove("menu-active");
        });
        
        // 关闭动态质量菜单
        const dynamicMenu = document.querySelector(".dynamic-quality-menu");
        if (dynamicMenu) {
            dynamicMenu.remove();
        }
        
        try {
            await downloadSong(song, quality);
        } catch (error) {
            console.error("下载失败:", error);
            showNotification("下载失败，请稍后重试", "error");
        }
    }
    
    // 修复：播放搜索结果 - 添加到播放列表而不是清空
    async function playSearchResult(index) {
        const song = state.searchResults[index];
        if (!song) return;

        if (song.type === "album") {
            openAlbumResult(index);
            return;
        }

        try {
            hideSearchResults();
            dom.searchInput.value = "";

            const existingIndex = state.playlistSongs.findIndex(s => s.id === song.id && s.source === song.source);
            let targetSong;

            if (existingIndex !== -1) {
                state.currentTrackIndex = existingIndex;
                state.currentPlaylist = "playlist";
                targetSong = state.playlistSongs[existingIndex];
            } else {
                targetSong = cloneSongData(song);
                state.playlistSongs.push(targetSong);
                state.currentTrackIndex = state.playlistSongs.length - 1;
                state.currentPlaylist = "playlist";
                renderPlaylist();
            }

            await playSong(targetSong);
            updatePlaylistHighlight();
            showNotification(`正在播放: ${targetSong.name}`);

        } catch (error) {
            console.error("播放失败:", error);
            showNotification("播放失败，请稍后重试", "error");
        }
    }

    // 新增：渲染统一播放列表
    function renderPlaylist() {
        if (!dom.playlistItems) return;

        if (state.playlistSongs.length === 0) {
            dom.playlist.classList.add("empty");
            dom.playlistItems.innerHTML = "";
            savePlayerState();
            updatePlaylistHighlight();
            return;
        }

        dom.playlist.classList.remove("empty");
        const playlistHtml = state.playlistSongs.map((song, index) =>
            `<div class="playlist-item" onclick="playPlaylistSong(${index})" data-index="${index}">
                ${song.name} - ${Array.isArray(song.artist) ? song.artist.join(", ") : song.artist}
                <button class="playlist-item-remove" onclick="event.stopPropagation(); removeFromPlaylist(${index})" title="从播放列表移除">
                    <i class="fas fa-times"></i>
                </button>
                <button class="playlist-item-download" onclick="event.stopPropagation(); showQualityMenu(event, ${index}, 'playlist')" title="下载">
                    <i class="fas fa-download"></i>
                </button>
            </div>`
        ).join("");

        dom.playlistItems.innerHTML = playlistHtml;
        savePlayerState();
        updatePlaylistHighlight();
    }

    // 新增：从播放列表移除歌曲
    function removeFromPlaylist(index) {
        if (index < 0 || index >= state.playlistSongs.length) return;

        const removingCurrent = state.currentPlaylist === "playlist" && state.currentTrackIndex === index;

        if (removingCurrent) {
            if (state.playlistSongs.length === 1) {
                dom.audioPlayer.pause();
                dom.audioPlayer.src = "";
                state.currentTrackIndex = -1;
                state.currentSong = null;
                state.currentAudioUrl = null;
                state.currentPlaybackTime = 0;
                state.lastSavedPlaybackTime = 0;
                dom.progressBar.value = 0;
                dom.progressBar.max = 0;
                dom.currentTimeDisplay.textContent = "00:00";
                dom.durationDisplay.textContent = "00:00";
                updateProgressBarBackground(0, 1);
                dom.currentSongTitle.textContent = "选择一首歌曲开始播放";
                dom.currentSongArtist.textContent = "未知艺术家";
                dom.albumCover.innerHTML = "<div class=\"placeholder\"><i class=\"fas fa-music\"></i></div>";
                dom.lyrics.innerHTML = "";
                dom.lyrics.classList.add("empty");
                updatePlayPauseButton();
            } else if (index === state.playlistSongs.length - 1) {
                state.currentTrackIndex = index - 1;
            }
        } else if (state.currentPlaylist === "playlist" && state.currentTrackIndex > index) {
            state.currentTrackIndex--;
        }

        state.playlistSongs.splice(index, 1);

        if (state.playlistSongs.length === 0) {
            dom.playlist.classList.add("empty");
            if (dom.playlistItems) {
                dom.playlistItems.innerHTML = "";
            }
            state.currentPlaylist = "playlist";
        } else {
            if (state.currentPlaylist === "playlist" && state.currentTrackIndex < 0) {
                state.currentTrackIndex = 0;
            }

            renderPlaylist();

            if (removingCurrent && state.currentPlaylist === "playlist" && state.currentTrackIndex >= 0) {
                const targetIndex = Math.min(state.currentTrackIndex, state.playlistSongs.length - 1);
                state.currentTrackIndex = targetIndex;
                playPlaylistSong(targetIndex);
            } else {
                updatePlaylistHighlight();
            }
        }

        savePlayerState();
        if (state.albumOverlayVisible) {
            renderAlbumTrackList(state.activeAlbumTracks);
        }
        showNotification("已从播放列表移除", "success");
    }

    // 新增：清空播放列表
    function clearPlaylist() {
        if (state.playlistSongs.length === 0) return;

        if (state.currentPlaylist === "playlist") {
            dom.audioPlayer.pause();
            dom.audioPlayer.src = "";
            state.currentTrackIndex = -1;
            state.currentSong = null;
            state.currentAudioUrl = null;
            state.currentPlaybackTime = 0;
            state.lastSavedPlaybackTime = 0;
            dom.progressBar.value = 0;
            dom.progressBar.max = 0;
            dom.currentTimeDisplay.textContent = "00:00";
            dom.durationDisplay.textContent = "00:00";
            updateProgressBarBackground(0, 1);
            dom.currentSongTitle.textContent = "选择一首歌曲开始播放";
            dom.currentSongArtist.textContent = "未知艺术家";
            dom.albumCover.innerHTML = "<div class=\"placeholder\"><i class=\"fas fa-music\"></i></div>";
            dom.lyrics.innerHTML = "";
            dom.lyrics.classList.add("empty");
            updatePlayPauseButton();
        }

        state.playlistSongs = [];
        dom.playlist.classList.add("empty");
        if (dom.playlistItems) {
            dom.playlistItems.innerHTML = "";
        }
        state.currentPlaylist = "playlist";

        savePlayerState();
        if (state.albumOverlayVisible) {
            renderAlbumTrackList(state.activeAlbumTracks);
        }
        showNotification("播放列表已清空", "success");
    }

    // 新增：播放播放列表中的歌曲
    async function playPlaylistSong(index) {
        if (index < 0 || index >= state.playlistSongs.length) return;
        
        const song = state.playlistSongs[index];
        state.currentTrackIndex = index;
        state.currentPlaylist = "playlist";
        
        try {
            await playSong(song);
            updatePlaylistHighlight();
        } catch (error) {
            console.error("播放失败:", error);
            showNotification("播放失败，请稍后重试", "error");
        }
    }

    // 新增：更新播放列表高亮
    function updatePlaylistHighlight() {
        if (!dom.playlistItems) return;
        const playlistItems = dom.playlistItems.querySelectorAll(".playlist-item");
        playlistItems.forEach((item, index) => {
            if (state.currentPlaylist === "playlist" && index === state.currentTrackIndex) {
                item.classList.add("current");
            } else {
                item.classList.remove("current");
            }
        });
    }

    // 修复：播放歌曲函数 - 支持统一播放列表
    function waitForAudioReady(player) {
        if (!player) return Promise.resolve();
        if (player.readyState >= 1) {
            return Promise.resolve();
        }
        return new Promise((resolve, reject) => {
            const cleanup = () => {
                player.removeEventListener('loadedmetadata', onLoaded);
                player.removeEventListener('error', onError);
            };
            const onLoaded = () => {
                cleanup();
                resolve();
            };
            const onError = () => {
                cleanup();
                reject(new Error('音频加载失败'));
            };
            player.addEventListener('loadedmetadata', onLoaded, { once: true });
            player.addEventListener('error', onError, { once: true });
        });
    }

    async function playSong(song, options = {}) {
        const { autoplay = true, startTime = 0, preserveProgress = false } = options;

        try {
            await updateCurrentSongInfo(song);

            const quality = state.playbackQuality || '320';
            const audioUrl = API.getSongUrl(song, quality);
            debugLog(`获取音频URL: ${audioUrl}`);

            const audioData = await API.fetchJson(audioUrl);

            if (!audioData || !audioData.url) {
                throw new Error('无法获取音频播放地址');
            }

            const originalAudioUrl = audioData.url;
            const proxiedAudioUrl = buildAudioProxyUrl(originalAudioUrl);
            const preferredAudioUrl = preferHttpsUrl(originalAudioUrl);
            const candidateAudioUrls = Array.from(
                new Set([proxiedAudioUrl, preferredAudioUrl, originalAudioUrl].filter(Boolean))
            );

            const primaryAudioUrl = candidateAudioUrls[0] || originalAudioUrl;

            if (proxiedAudioUrl && proxiedAudioUrl !== originalAudioUrl) {
                debugLog(`音频地址已通过代理转换为 HTTPS: ${proxiedAudioUrl}`);
            } else if (preferredAudioUrl && preferredAudioUrl !== originalAudioUrl) {
                debugLog(`音频地址由 HTTP 升级为 HTTPS: ${preferredAudioUrl}`);
            }

            state.currentSong = song;
            state.currentAudioUrl = null;

            dom.audioPlayer.pause();

            if (!preserveProgress) {
                state.currentPlaybackTime = 0;
                state.lastSavedPlaybackTime = 0;
                safeSetLocalStorage('currentPlaybackTime', '0');
            } else if (startTime > 0) {
                state.currentPlaybackTime = startTime;
                state.lastSavedPlaybackTime = startTime;
            }

            state.pendingSeekTime = startTime > 0 ? startTime : null;

            let selectedAudioUrl = null;
            let lastAudioError = null;
            let usedFallbackAudio = false;

            for (const candidateUrl of candidateAudioUrls) {
                dom.audioPlayer.src = candidateUrl;
                dom.audioPlayer.load();

                try {
                    await waitForAudioReady(dom.audioPlayer);
                    selectedAudioUrl = candidateUrl;
                    usedFallbackAudio = candidateUrl !== primaryAudioUrl && candidateAudioUrls.length > 1;
                    break;
                } catch (error) {
                    lastAudioError = error;
                    console.warn('音频元数据加载异常', error);

                    if (candidateUrl === primaryAudioUrl && candidateAudioUrls.length > 1) {
                        debugLog('主音频地址加载失败，尝试使用备用地址');
                    }
                }
            }

            if (!selectedAudioUrl) {
                throw lastAudioError || new Error('音频加载失败');
            }

            if (usedFallbackAudio) {
                debugLog(`已回退至备用音频地址: ${selectedAudioUrl}`);
                showNotification('主音频加载失败，已切换到备用音源', 'warning');
            }

            state.currentAudioUrl = selectedAudioUrl;

            if (state.pendingSeekTime != null) {
                setAudioCurrentTime(state.pendingSeekTime);
                state.pendingSeekTime = null;
            } else {
                setAudioCurrentTime(dom.audioPlayer.currentTime || 0);
            }

            state.lastSavedPlaybackTime = state.currentPlaybackTime;

            if (autoplay) {
                const playPromise = dom.audioPlayer.play();
                if (playPromise !== undefined) {
                    playPromise.catch(error => {
                        console.error('播放失败:', error);
                        showNotification('播放失败，请检查网络连接', 'error');
                    });
                }
            } else {
                dom.audioPlayer.pause();
                updatePlayPauseButton();
            }

            loadLyrics(song);

            debugLog(`开始播放: ${song.name} @${quality}`);
        } catch (error) {
            console.error('播放歌曲失败:', error);
            throw error;
        } finally {
            savePlayerState();
        }
    }

    // 修复：自动播放下一首 - 支持播放模式
    function autoPlayNext() {
        if (state.playMode === "single") {
            // 单曲循环
            dom.audioPlayer.currentTime = 0;
            dom.audioPlayer.play();
            return;
        }

        playNext();
        updatePlayPauseButton();
    }

    // 修复：播放下一首 - 支持播放模式和统一播放列表
    function playNext() {
        let nextIndex = -1;
        let playlist = [];
        
        if (state.currentPlaylist === "playlist") {
            playlist = state.playlistSongs;
        } else if (state.currentPlaylist === "online") {
            playlist = state.onlineSongs;
        } else if (state.currentPlaylist === "search") {
            playlist = state.searchResults;
        }
        
        if (playlist.length === 0) return;
        
        if (state.playMode === "random") {
            // 随机播放
            nextIndex = Math.floor(Math.random() * playlist.length);
        } else {
            // 列表循环
            nextIndex = (state.currentTrackIndex + 1) % playlist.length;
        }
        
        state.currentTrackIndex = nextIndex;
        
        if (state.currentPlaylist === "playlist") {
            playPlaylistSong(nextIndex);
        } else if (state.currentPlaylist === "online") {
            playOnlineSong(nextIndex);
        } else if (state.currentPlaylist === "search") {
            playSearchResult(nextIndex);
        }
    }

    // 修复：播放上一首 - 支持播放模式和统一播放列表
    function playPrevious() {
        let prevIndex = -1;
        let playlist = [];
        
        if (state.currentPlaylist === "playlist") {
            playlist = state.playlistSongs;
        } else if (state.currentPlaylist === "online") {
            playlist = state.onlineSongs;
        } else if (state.currentPlaylist === "search") {
            playlist = state.searchResults;
        }
        
        if (playlist.length === 0) return;
        
        if (state.playMode === "random") {
            // 随机播放
            prevIndex = Math.floor(Math.random() * playlist.length);
        } else {
            // 列表循环
            prevIndex = state.currentTrackIndex - 1;
            if (prevIndex < 0) prevIndex = playlist.length - 1;
        }
        
        state.currentTrackIndex = prevIndex;
        
        if (state.currentPlaylist === "playlist") {
            playPlaylistSong(prevIndex);
        } else if (state.currentPlaylist === "online") {
            playOnlineSong(prevIndex);
        } else if (state.currentPlaylist === "search") {
            playSearchResult(prevIndex);
        }
    }

    // 修复：在线音乐播放函数
    async function playOnlineSong(index) {
        const song = state.onlineSongs[index];
        if (!song) return;
        
        state.currentTrackIndex = index;
        state.currentPlaylist = "online";
        
        try {
            await playSong(song);
            updateOnlineHighlight();
        } catch (error) {
            console.error("播放失败:", error);
            showNotification("播放失败，请稍后重试", "error");
        }
    }

    // 修复：更新在线音乐高亮
    function updateOnlineHighlight() {
        if (!dom.playlistItems) return;
        const playlistItems = dom.playlistItems.querySelectorAll(".playlist-item");
        playlistItems.forEach((item, index) => {
            if (state.currentPlaylist === "online" && index === state.currentTrackIndex) {
                item.classList.add("current");
            } else {
                item.classList.remove("current");
            }
        });
    }

    // 修复：探索在线音乐 - 添加到统一播放列表
    async function exploreOnlineMusic() {
        const btn = dom.loadOnlineBtn;
        const btnText = btn.querySelector(".btn-text");
        const loader = btn.querySelector(".loader");
        
        try {
            btn.disabled = true;
            btnText.style.display = "none";
            loader.style.display = "inline-block";
            
            const results = await API.getList("热门", 50, 1);
            const songs = results.filter(item => item && item.type !== "album");

            if (songs.length > 0) {
                const existingKeys = new Set(state.playlistSongs.map(song => `${song.source || 'netease'}_${song.id}`));
                const newSongs = songs.filter(song => {
                    const key = `${song.source || 'netease'}_${song.id}`;
                    if (existingKeys.has(key)) {
                        return false;
                    }
                    existingKeys.add(key);
                    return true;
                }).map(song => cloneSongData(song));

                if (newSongs.length > 0) {
                    state.playlistSongs = [...state.playlistSongs, ...newSongs];
                    renderPlaylist();
                    if (state.albumOverlayVisible) {
                        renderAlbumTrackList(state.activeAlbumTracks);
                    }
                }

                state.onlineSongs = songs;

                const message = newSongs.length > 0
                    ? `已加载 ${newSongs.length} 首热门歌曲到播放列表`
                    : "热门歌曲已全部存在于播放列表";
                showNotification(message, newSongs.length > 0 ? "success" : "warning");
                debugLog(`加载在线音乐成功: ${songs.length} 首歌曲，可添加 ${newSongs.length} 首`);
            } else {
                showNotification("未找到在线音乐", "error");
            }
        } catch (error) {
            console.error("加载在线音乐失败:", error);
            showNotification("加载失败，请稍后重试", "error");
        } finally {
            btn.disabled = false;
            btnText.style.display = "flex";
            loader.style.display = "none";
        }
    }

    // 修复：加载歌词
    async function loadLyrics(song) {
        try {
            const lyricUrl = API.getLyric(song);
            debugLog(`获取歌词URL: ${lyricUrl}`);
            
            const lyricData = await API.fetchJson(lyricUrl);
            
            if (lyricData && lyricData.lyric) {
                parseLyrics(lyricData.lyric);
                dom.lyrics.classList.remove("empty");
            } else {
                dom.lyrics.innerHTML = "<div>暂无歌词</div>";
                dom.lyrics.classList.add("empty");
                state.lyricsData = [];
            }
        } catch (error) {
            console.error("加载歌词失败:", error);
            dom.lyrics.innerHTML = "<div>歌词加载失败</div>";
            dom.lyrics.classList.add("empty");
            state.lyricsData = [];
        }
    }

    // 修复：解析歌词
    function parseLyrics(lyricText) {
        const lines = lyricText.split('\n');
        const lyrics = [];
        
        lines.forEach(line => {
            const match = line.match(/\[(\d{2}):(\d{2})\.(\d{2,3})\](.*)/);
            if (match) {
                const minutes = parseInt(match[1]);
                const seconds = parseInt(match[2]);
                const milliseconds = parseInt(match[3].padEnd(3, '0'));
                const time = minutes * 60 + seconds + milliseconds / 1000;
                const text = match[4].trim();
                
                if (text) {
                    lyrics.push({ time, text });
                }
            }
        });
        
        state.lyricsData = lyrics.sort((a, b) => a.time - b.time);
        displayLyrics();
    }

    // 修复：显示歌词
    function displayLyrics() {
        const lyricsHtml = state.lyricsData.map((lyric, index) => 
            `<div data-time="${lyric.time}" data-index="${index}">${lyric.text}</div>`
        ).join("");
        dom.lyrics.innerHTML = lyricsHtml;
    }

    // 修复：同步歌词
    function syncLyrics() {
        if (state.lyricsData.length === 0) return;
        
        const currentTime = dom.audioPlayer.currentTime;
        let currentIndex = -1;
        
        for (let i = 0; i < state.lyricsData.length; i++) {
            if (currentTime >= state.lyricsData[i].time) {
                currentIndex = i;
            } else {
                break;
            }
        }
        
        if (currentIndex !== state.currentLyricLine) {
            state.currentLyricLine = currentIndex;
            
            const lyricElements = dom.lyrics.querySelectorAll("div[data-index]");
            lyricElements.forEach((element, index) => {
                if (index === currentIndex) {
                    element.classList.add("current");
                    // 只有在用户没有手动滚动时才自动滚动
                    if (!state.userScrolledLyrics) {
                        scrollToCurrentLyric(element);
                    }
                } else {
                    element.classList.remove("current");
                }
            });
        }
    }

    // 新增：滚动到当前歌词 - 修复居中显示问题
    function scrollToCurrentLyric(element) {
        const container = dom.lyrics;
        const containerHeight = container.clientHeight;
        const elementRect = element.getBoundingClientRect();
        const containerRect = container.getBoundingClientRect();

        // 计算元素在容器内部的可视位置，避免受到 offsetParent 影响
        const elementOffsetTop = elementRect.top - containerRect.top + container.scrollTop;
        const elementHeight = elementRect.height;

        // 目标滚动位置：让当前歌词的中心与容器中心对齐
        const targetScrollTop = elementOffsetTop - (containerHeight / 2) + (elementHeight / 2);

        const maxScrollTop = container.scrollHeight - containerHeight;
        const finalScrollTop = Math.max(0, Math.min(targetScrollTop, maxScrollTop));

        if (Math.abs(container.scrollTop - finalScrollTop) > 1) {
            container.scrollTo({
                top: finalScrollTop,
                behavior: 'smooth'
            });
        }

        debugLog(`歌词滚动: 元素在容器内偏移=${elementOffsetTop}, 容器高度=${containerHeight}, 目标滚动=${finalScrollTop}`);
    }

    // 修复：下载歌曲
    async function downloadSong(song, quality = "320") {
        try {
            showNotification("正在准备下载...");

            const audioUrl = API.getSongUrl(song, quality);
            const audioData = await API.fetchJson(audioUrl);

            if (audioData && audioData.url) {
                const proxiedAudioUrl = buildAudioProxyUrl(audioData.url);
                const preferredAudioUrl = preferHttpsUrl(audioData.url);

                if (proxiedAudioUrl !== audioData.url) {
                    debugLog(`下载链接已通过代理转换为 HTTPS: ${proxiedAudioUrl}`);
                } else if (preferredAudioUrl !== audioData.url) {
                    debugLog(`下载链接由 HTTP 升级为 HTTPS: ${preferredAudioUrl}`);
                }

                const downloadUrl = proxiedAudioUrl || preferredAudioUrl || audioData.url;

                const link = document.createElement("a");
                link.href = downloadUrl;
                const preferredExtension =
                    quality === "999" ? "flac" : quality === "740" ? "ape" : "mp3";
                const fileExtension = (() => {
                    try {
                        const url = new URL(audioData.url);
                        const pathname = url.pathname || "";
                        const match = pathname.match(/\.([a-z0-9]+)$/i);
                        if (match) {
                            return match[1];
                        }
                    } catch (error) {
                        console.warn("无法从下载链接中解析扩展名:", error);
                    }
                    return preferredExtension;
                })();
                link.download = `${song.name} - ${Array.isArray(song.artist) ? song.artist.join(", ") : song.artist}.${fileExtension}`;
                link.target = "_blank";
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showNotification("下载已开始", "success");
            } else {
                throw new Error("无法获取下载地址");
            }
        } catch (error) {
            console.error("下载失败:", error);
            showNotification("下载失败，请稍后重试", "error");
        }
    }

    // 修复：移动端视图切换
    function switchMobileView(view) {
        if (view === "playlist") {
            dom.showPlaylistBtn.classList.add("active");
            dom.showLyricsBtn.classList.remove("active");
            dom.playlist.classList.add("active");
            dom.lyrics.classList.remove("active");
        } else if (view === "lyrics") {
            dom.showLyricsBtn.classList.add("active");
            dom.showPlaylistBtn.classList.remove("active");
            dom.lyrics.classList.add("active");
            dom.playlist.classList.remove("active");
        }
    }

    // 修复：显示通知
    function showNotification(message, type = "success") {
        const notification = dom.notification;
        notification.textContent = message;
        notification.className = `notification ${type}`;
        notification.classList.add("show");
        
        setTimeout(() => {
            notification.classList.remove("show");
        }, 3000);
    }
</script>
</body>
</html>
